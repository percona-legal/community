<!doctype html><html lang=en prefix="og: https://ogp.me/ns#"><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,initial-scale=1,minimum-scale=1"><title>Finding MySQL Scaling Problems Using perf | Percona Community</title><meta name=description content="The thing I wish I&rsquo;d learned while still a DBA is how to use perf. Conversely after moving to a developer role, getting access to real external client workloads to get a perf recording directly is rare. To bridge this gap, I hope to encourage a bit of perf usage to help DBAs report bugs/feature requests in more detail to MySQL developers, who can then serve your needs better.
   A recent client request showed how useful perf is in exposing the areas of MySQL that are otherwise well tuned, but can still be in need of coding improvements that increase throughput."><link rel=canonical href=https://percona.community/blog/2020-02-05-finding-mysql-scaling-problems-using-perf/><meta name=robots content="noindex,nofollow"><meta property="og:title" content="Finding MySQL Scaling Problems Using perf"><meta property="og:description" content="The thing I wish I&rsquo;d learned while still a DBA is how to use perf. Conversely after moving to a developer role, getting access to real external client workloads to get a perf recording directly is rare. To bridge this gap, I hope to encourage a bit of perf usage to help DBAs report bugs/feature requests in more detail to MySQL developers, who can then serve your needs better.
   A recent client request showed how useful perf is in exposing the areas of MySQL that are otherwise well tuned, but can still be in need of coding improvements that increase throughput."><meta property="og:type" content="article"><meta property="og:url" content="https://percona.community/blog/2020-02-05-finding-mysql-scaling-problems-using-perf/"><meta name=image property="og:image" content="https://percona.community/blog/2020/01/ricardo-gomez-angel-87vUJY3ntyI-unsplash_hu98532f7dd85fa9cb3a2892cba21b8302_283909_1200x0_resize_q90_lanczos.jpg"><meta property="article:published_time" content="2020-02-05T16:18:14+00:00"><meta property="article:modified_time" content="2020-02-05T16:18:14+00:00"><meta property="article:section" content="blog"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://percona.community/blog/2020/01/ricardo-gomez-angel-87vUJY3ntyI-unsplash.jpg"><meta name=twitter:title content="Finding MySQL Scaling Problems Using perf | Percona Community"><meta name=twitter:description content="The thing I wish I&rsquo;d learned while still a DBA is how to use perf. Conversely after moving to a developer role, getting access to real external client workloads to get a perf recording directly is rare. To bridge this gap, I hope to encourage a bit of perf usage to help DBAs report bugs/feature requests in more detail to MySQL developers, who can then serve your needs better.
   A recent client request showed how useful perf is in exposing the areas of MySQL that are otherwise well tuned, but can still be in need of coding improvements that increase throughput."><meta name=twitter:site content="@Percona"><meta name=description content="The thing I wish I&rsquo;d learned while still a DBA is how to use perf. Conversely after moving to a developer role, getting access to real external client workloads to get a perf recording directly is rare. To bridge this gap, I hope to encourage a bit of perf usage to help DBAs report bugs/feature requests in more detail to MySQL developers, who can then serve your needs better.
   A recent client request showed how useful perf is in exposing the areas of MySQL that are otherwise well tuned, but can still be in need of coding improvements that increase throughput."><meta name=copyright content="¬© Percona Community. MySQL, InnoDB, MariaDB and MongoDB are trademarks of their respective owners.
"><meta name=author content="Daniel Black"><style>@charset "UTF-8";html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,img,ins,kbd,q,s,samp,small,strike,strong,sub,sup,tt,var,b,u,i,center,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td,article,aside,canvas,details,embed,figure,figcaption,footer,header,hgroup,menu,nav,output,ruby,section,summary,time,mark,audio,video{margin:0;padding:0;border:0;vertical-align:baseline}article,aside,details,figcaption,figure,footer,header,hgroup,menu,nav,section{display:block}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:before,blockquote:after{content:none}q:before,q:after{content:none}table{border-collapse:collapse;border-spacing:0}html,body{font-family:Arial,sans-serif;scroll-behavior:smooth;text-rendering:optimizeSpeed;-webkit-font-smoothing:antialiased;line-height:1.5rem;font-feature-settings:"liga" 1;font-weight:500;font-size:18px}@media(min-width:900px){html,body{font-size:20px}}@media(min-width:1100px){html,body{font-size:22px}}@media(min-width:1800px){html,body{font-size:24px}}@media print{html,body{font-size:18px}}hr{border:0;height:2px;background-color:#fe7f2d;margin-top:1.5rem;margin-bottom:1.5rem}.text{position:relative}.text .meta{font-variant:small-caps}.text .meta .byline{display:none}.text .meta .line{display:inline-block}.text .meta .calendar{display:none}.text h1,.text h2,.text h3,.text h4,.text h5,.text h6{font-family:Georgia,palatino linotype,book antiqua,Palatino,times new roman,serif;font-weight:500;page-break-after:avoid}.text h1 a,.text h1 a:visited,.text h2 a,.text h2 a:visited,.text h3 a,.text h3 a:visited,.text h4 a,.text h4 a:visited,.text h5 a,.text h5 a:visited,.text h6 a,.text h6 a:visited{color:#2a2d34;text-decoration:none}.text p,.text ul,.text ol,.text figure,.text dl,.text hr{margin-top:1.5rem;font-size:1rem}.text q{font-style:italic}.text ul ul{margin-top:0}.text p>code,.text ul>code,.text ol>code,.text dt>code,.text dd>code,.text li>code{color:#009b72}.text button{cursor:pointer;display:inline-block;box-sizing:border-box;border:.1rem solid #6761a8;height:1.5rem;padding-left:.75rem;padding-right:.75rem;border-radius:.2rem;transition:color .233s ease-in-out,background-color .233s ease-in-out}.text button:hover{color:#fff;background-color:#6761a8}.text audio{display:block;width:100%;height:1.5rem;outline:none}.text audio span{line-height:1.5rem}.text dl{overflow:auto;position:relative}.text dt{font-weight:700}.text dd{padding-left:2rem}.text dd+dt{margin-top:1.5rem}.text ul{list-style-type:disc;padding-left:1.5rem}.text ol{list-style-type:decimal;padding-left:1.5rem}.text p{overflow-wrap:break-word;word-wrap:break-word;-webkit-hyphens:auto;-moz-hyphens:auto;-ms-hyphens:auto;hyphens:auto}.text h1{font-size:2.5rem;font-weight:500;line-height:3rem;margin-top:1.5rem;margin-bottom:0}@media screen and (min-width:760px){.text h1{font-size:3.5rem;line-height:4.5rem;margin-top:1.5rem}}@media screen and (min-width:900px){.text h1{font-size:4rem;line-height:4.5rem;margin-top:3rem}}@media screen and (min-width:1400px){.text h1{font-size:5rem;line-height:6rem;margin-top:6rem}}.text h2{font-size:2rem;line-height:3rem;margin-top:3rem;margin-bottom:3rem}.text h3{font-size:1.5rem;line-height:1.5rem;margin-top:1.5rem;margin-bottom:1.5rem}.text h4{font-size:1rem;line-height:1.5rem;margin-top:1.5rem;margin-bottom:1.5rem}.text h5{font-size:.8rem;line-height:1.5rem;margin-top:1.5rem;margin-bottom:1.5rem}.text h6{font-size:.6rem;line-height:1.5rem;margin-top:1.5rem;margin-bottom:1.5rem}.text strong{font-weight:700}.text em{font-style:italic}.text blockquote{border-left:.2rem solid #999;padding-left:.75rem}.text code{font-family:lucida console,Monaco,monospace;speak:literal-punctuation}.text abbr,.text acronym{speak:spell-out}.text del{text-decoration:line-through}.text ins{text-decoration:none;font-style:italic}.text figure{position:relative;text-align:center}.text figure img{background:#fff;border-radius:.2rem;max-width:100%}.text figure table{min-width:75%;border-radius:.2rem;margin-left:auto;margin-right:auto;border:#6761a8;border-collapse:separate;border-spacing:0;background:#fff;margin-bottom:-.1em}.text figure table th,.text figure table td{padding-left:.75rem;padding-right:.75rem;line-height:1.3rem;border-left:.1rem solid #6761a8;border-top:.1rem solid #6761a8}.text figure table thead{background-color:#fff}.text figure table tr td:last-child,.text figure table tr th:last-child{border-right:.1rem solid #6761a8}.text figure table tbody:last-child tr:last-child td{border-bottom:.1rem solid #6761a8}.text figure table thead:first-child tr:first-child th:first-child,.text figure table thead:first-child tr:first-child td:first-child{border-top-left-radius:.2rem}.text figure table thead:first-child tr:first-child,.text figure table thead:first-child tr:first-child th:last-child,.text figure table thead:first-child tr:first-child td:last-child{border-top-right-radius:.2rem}.text figure table tbody:last-child tr:last-child,.text figure table tbody:last-child tr:last-child td:first-child{border-bottom-left-radius:.2rem}.text figure table tbody:last-child tr:last-child,.text figure table tbody:last-child tr:last-child td:last-child{border-bottom-right-radius:.2rem}.text figure ul{text-align:left}.text figure ul.tree{padding-top:1.5em;padding-bottom:1.5em;border-radius:.2rem;background:#fff}.text figure ul.tree li{list-style-type:none}.text figure ul.tree .tree__item--folder::before{content:"üìÅ";margin-right:.2em}.text figure ul.tree .tree__item--file::before{content:"üìù";margin-right:.2em}.text figure figcaption{font-style:italic}.text pre{margin-top:1.5rem;font-size:inherit;line-height:1.5rem;padding:1.5rem 1.5rem .75rem;white-space:pre;overflow-x:scroll;overflow-y:hidden;scrollbar-color:#cccccc transparent;scrollbar-width:.75rem}.text pre::-webkit-scrollbar{margin-top:-.75rem;height:.75rem}.text pre::-webkit-scrollbar-track{background:0 0}.text pre::-webkit-scrollbar-thumb{height:.1rem;border-radius:.2rem;background:#ccc}.text hr{border:0;height:.2rem;background:#6761a8;margin-top:1.3rem}.text .admonition{position:relative}.text .admonition>*{padding-left:2rem}.text .admonition>:first-child::before{display:block;text-align:left;position:absolute;top:0;left:0;width:.75rem;font-size:1rem;line-height:1.5rem;height:1.5rem}.text .admonition--tip>:first-child::before{content:"‚òõ";color:#00a000;font-size:1.5rem;line-height:1.5rem;height:1.5rem}.text .admonition--warning>:first-child::before{content:"‚ö†Ô∏è";color:#fe7f2d}.text .admonition--info>:first-child::before{content:"‚ìò";color:#004966;font-weight:700}@media print{.text h1{margin-left:auto;margin-right:auto;margin-top:9rem;width:80%;font-variant:small-caps;text-align:center}.text--simple h1{margin-top:0}.text .meta{page-break-after:always;text-align:center;font-size:1.2rem;margin-top:1.5rem}.text .meta a{text-decoration:none}.text .meta time{display:none}.text .body p:first-of-type{margin-top:0}.text pre{padding:0;font-size:inherit;line-height:1.5rem;overflow:hidden;white-space:pre-wrap;word-break:break-all}}.text .podcasts{margin-top:1.5rem;text-align:center}.text a.podcast{display:block;height:3rem}.text a.podcast img{width:50%;max-width:200px}@media screen and (min-width:768px){.text .podcasts{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));grid-gap:1.5rem}.text a.podcast img{width:100%}}.text .tombstone{opacity:0}html,body{min-height:100vh}body{text-align:center}@media screen{body{color:#2a2d34;background-color:#fefefe}}@media print{body{color:#000;background:#fff}}@media screen{body{display:flex;flex-direction:column}main.page{width:100%;flex:1}}header.page,main.page,footer.page{text-align:left}.page-main,.contentblock{max-width:1400px;padding-left:1.5rem;padding-right:1.5rem;margin-left:auto;margin-right:auto}@media print{.page-main,.contentblock{padding:0}}@page{size:A4;padding:0;margin:3rem}.highlight{color:#6761a8}.nobr{white-space:nowrap}.aria-only{display:none}@media aural{.aria-only{display:block}}a{color:#004966;text-decoration-color:#a2dffb;transition:color .233s ease-out,text-decoration-color .233s ease-out}a:hover,a:visited:hover{color:#fe7f2d}a:active{color:#fe7f2d}a:visited{color:#6761a8;text-decoration-color:#009b72}html,body{font-family:Arial,sans-serif;scroll-behavior:smooth;text-rendering:optimizeSpeed;-webkit-font-smoothing:antialiased;line-height:1.5rem;font-feature-settings:"liga" 1;font-weight:500;font-size:18px}@media(min-width:900px){html,body{font-size:20px}}@media(min-width:1100px){html,body{font-size:22px}}@media(min-width:1800px){html,body{font-size:24px}}@media print{html,body{font-size:18px}}hr{border:0;height:2px;background-color:#fe7f2d;margin-top:1.5rem;margin-bottom:1.5rem}.text{position:relative}.text .meta{font-variant:small-caps}.text .meta .byline{display:none}.text .meta .line{display:inline-block}.text .meta .calendar{display:none}.text h1,.text h2,.text h3,.text h4,.text h5,.text h6{font-family:Georgia,palatino linotype,book antiqua,Palatino,times new roman,serif;font-weight:500;page-break-after:avoid}.text h1 a,.text h1 a:visited,.text h2 a,.text h2 a:visited,.text h3 a,.text h3 a:visited,.text h4 a,.text h4 a:visited,.text h5 a,.text h5 a:visited,.text h6 a,.text h6 a:visited{color:#2a2d34;text-decoration:none}.text p,.text ul,.text ol,.text figure,.text dl,.text hr{margin-top:1.5rem;font-size:1rem}.text q{font-style:italic}.text ul ul{margin-top:0}.text p>code,.text ul>code,.text ol>code,.text dt>code,.text dd>code,.text li>code{color:#009b72}.text button{cursor:pointer;display:inline-block;box-sizing:border-box;border:.1rem solid #6761a8;height:1.5rem;padding-left:.75rem;padding-right:.75rem;border-radius:.2rem;transition:color .233s ease-in-out,background-color .233s ease-in-out}.text button:hover{color:#fff;background-color:#6761a8}.text audio{display:block;width:100%;height:1.5rem;outline:none}.text audio span{line-height:1.5rem}.text dl{overflow:auto;position:relative}.text dt{font-weight:700}.text dd{padding-left:2rem}.text dd+dt{margin-top:1.5rem}.text ul{list-style-type:disc;padding-left:1.5rem}.text ol{list-style-type:decimal;padding-left:1.5rem}.text p{overflow-wrap:break-word;word-wrap:break-word;-webkit-hyphens:auto;-moz-hyphens:auto;-ms-hyphens:auto;hyphens:auto}.text h1{font-size:2.5rem;font-weight:500;line-height:3rem;margin-top:1.5rem;margin-bottom:0}@media screen and (min-width:760px){.text h1{font-size:3.5rem;line-height:4.5rem;margin-top:1.5rem}}@media screen and (min-width:900px){.text h1{font-size:4rem;line-height:4.5rem;margin-top:3rem}}@media screen and (min-width:1400px){.text h1{font-size:5rem;line-height:6rem;margin-top:6rem}}.text h2{font-size:2rem;line-height:3rem;margin-top:3rem;margin-bottom:3rem}.text h3{font-size:1.5rem;line-height:1.5rem;margin-top:1.5rem;margin-bottom:1.5rem}.text h4{font-size:1rem;line-height:1.5rem;margin-top:1.5rem;margin-bottom:1.5rem}.text h5{font-size:.8rem;line-height:1.5rem;margin-top:1.5rem;margin-bottom:1.5rem}.text h6{font-size:.6rem;line-height:1.5rem;margin-top:1.5rem;margin-bottom:1.5rem}.text strong{font-weight:700}.text em{font-style:italic}.text blockquote{border-left:.2rem solid #999;padding-left:.75rem}.text code{font-family:lucida console,Monaco,monospace;speak:literal-punctuation}.text abbr,.text acronym{speak:spell-out}.text del{text-decoration:line-through}.text ins{text-decoration:none;font-style:italic}.text figure{position:relative;text-align:center}.text figure img{background:#fff;border-radius:.2rem;max-width:100%}.text figure table{min-width:75%;border-radius:.2rem;margin-left:auto;margin-right:auto;border:#6761a8;border-collapse:separate;border-spacing:0;background:#fff;margin-bottom:-.1em}.text figure table th,.text figure table td{padding-left:.75rem;padding-right:.75rem;line-height:1.3rem;border-left:.1rem solid #6761a8;border-top:.1rem solid #6761a8}.text figure table thead{background-color:#fff}.text figure table tr td:last-child,.text figure table tr th:last-child{border-right:.1rem solid #6761a8}.text figure table tbody:last-child tr:last-child td{border-bottom:.1rem solid #6761a8}.text figure table thead:first-child tr:first-child th:first-child,.text figure table thead:first-child tr:first-child td:first-child{border-top-left-radius:.2rem}.text figure table thead:first-child tr:first-child,.text figure table thead:first-child tr:first-child th:last-child,.text figure table thead:first-child tr:first-child td:last-child{border-top-right-radius:.2rem}.text figure table tbody:last-child tr:last-child,.text figure table tbody:last-child tr:last-child td:first-child{border-bottom-left-radius:.2rem}.text figure table tbody:last-child tr:last-child,.text figure table tbody:last-child tr:last-child td:last-child{border-bottom-right-radius:.2rem}.text figure ul{text-align:left}.text figure ul.tree{padding-top:1.5em;padding-bottom:1.5em;border-radius:.2rem;background:#fff}.text figure ul.tree li{list-style-type:none}.text figure ul.tree .tree__item--folder::before{content:"üìÅ";margin-right:.2em}.text figure ul.tree .tree__item--file::before{content:"üìù";margin-right:.2em}.text figure figcaption{font-style:italic}.text pre{margin-top:1.5rem;font-size:inherit;line-height:1.5rem;padding:1.5rem 1.5rem .75rem;white-space:pre;overflow-x:scroll;overflow-y:hidden;scrollbar-color:#cccccc transparent;scrollbar-width:.75rem}.text pre::-webkit-scrollbar{margin-top:-.75rem;height:.75rem}.text pre::-webkit-scrollbar-track{background:0 0}.text pre::-webkit-scrollbar-thumb{height:.1rem;border-radius:.2rem;background:#ccc}.text hr{border:0;height:.2rem;background:#6761a8;margin-top:1.3rem}.text .admonition{position:relative}.text .admonition>*{padding-left:2rem}.text .admonition>:first-child::before{display:block;text-align:left;position:absolute;top:0;left:0;width:.75rem;font-size:1rem;line-height:1.5rem;height:1.5rem}.text .admonition--tip>:first-child::before{content:"‚òõ";color:#00a000;font-size:1.5rem;line-height:1.5rem;height:1.5rem}.text .admonition--warning>:first-child::before{content:"‚ö†Ô∏è";color:#fe7f2d}.text .admonition--info>:first-child::before{content:"‚ìò";color:#004966;font-weight:700}@media print{.text h1{margin-left:auto;margin-right:auto;margin-top:9rem;width:80%;font-variant:small-caps;text-align:center}.text--simple h1{margin-top:0}.text .meta{page-break-after:always;text-align:center;font-size:1.2rem;margin-top:1.5rem}.text .meta a{text-decoration:none}.text .meta time{display:none}.text .body p:first-of-type{margin-top:0}.text pre{padding:0;font-size:inherit;line-height:1.5rem;overflow:hidden;white-space:pre-wrap;word-break:break-all}}.text .podcasts{margin-top:1.5rem;text-align:center}.text a.podcast{display:block;height:3rem}.text a.podcast img{width:50%;max-width:200px}@media screen and (min-width:768px){.text .podcasts{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));grid-gap:1.5rem}.text a.podcast img{width:100%}}.text .tombstone{opacity:0}.page-header a{display:block;text-decoration:none;height:2.6rem;line-height:2.6rem;border-top:.2rem solid transparent;border-bottom:.2rem solid transparent}.page-header a,.page-header a span{transition:color .233s ease-in-out,border-bottom .233s,margin-bottom .233s}.page-header a:hover{color:#004966;border-bottom:.2rem solid #004966}.page-header a:hover span{color:#004966}.page-header a img{height:2.6rem}.page-header a{color:#2a2d34;border-bottom:0 solid #fefefe}.page-header a:hover{color:#004966;border-bottom-color:#004966}.page-header a:visited{color:#2a2d34}.page-header a{display:block;border-bottom-width:0;font-weight:700}.page-header .logo{z-index:6;font-size:1.2rem;font-weight:700;font-variant:small-caps}.page-header .logo a{margin-top:.2rem;text-decoration:none;display:block;border:none}#show-mobile-menu{display:none}.mobile-toggle{display:none}@media screen and (max-width:759px){header.page{box-shadow:0 0 3px rgba(168,168,168,.5)}.logo a{position:absolute}.page-header{justify-content:space-between;z-index:1}.hamburger-bar{height:.2rem;background:#2a2d34;margin-top:.2rem;display:block}#show-mobile-menu+.mobile-toggle+.mobile-menu nav{background:#fefefe}#show-mobile-menu+.mobile-toggle .hamburger-bar{transform:translateY(0)rotate(0);opacity:1;transition:transform .233s ease-in-out,opacity .233s ease-in-out}#show-mobile-menu:checked+.mobile-toggle{position:fixed;right:1.5rem}#show-mobile-menu:checked+.mobile-toggle .hamburger-bar:nth-of-type(1){transform:translateY(.4rem)rotate(315deg)}#show-mobile-menu:checked+.mobile-toggle .hamburger-bar:nth-of-type(2){opacity:0}#show-mobile-menu:checked+.mobile-toggle .hamburger-bar:nth-of-type(3){transform:translateY(-.4rem)rotate(405deg)}.mobile-toggle{cursor:pointer;display:block;width:1.2rem;height:1rem;z-index:5;margin-top:.75rem}.mobile-toggle label,.mobile-toggle .hamburger-bar{cursor:pointer}.mobile-menu{overflow:hidden;position:fixed;top:0;left:0;right:0;bottom:100vh;opacity:0;background:rgba(0,0,0,.5);transition:opacity .233s ease-in-out,bottom .233s ease-in-out}#show-mobile-menu:checked+.mobile-toggle+.mobile-menu{opacity:1;bottom:0}.hide-mobile-menu{display:block;position:absolute;top:0;left:0;right:0;bottom:0;z-index:2}.mobile-menu nav{box-sizing:border-box;max-height:100%;position:absolute;top:0;left:0;right:0;z-index:3;font-size:1rem;line-height:3rem;padding:3rem 1.5rem 1.5rem;display:flex;flex-direction:column}.mobile-menu nav header{display:flex;flex-direction:row;font-size:inherit;line-height:inherit}.mobile-menu nav header h1{margin-top:0;font-size:1.2rem;line-height:1.5rem;flex:1;font-variant:small-caps}.mobile-menu nav header .hide-mobile-menu-aria{display:block;z-index:10;height:1.5rem;width:1.5rem}.mobile-menu nav ul{overflow-y:scroll;flex:1;scrollbar-width:none;-ms-overflow-style:none}.mobile-menu nav ul::-webkit-scrollbar{width:0;background:0 0}.mobile-menu nav a:hover{border-bottom:0;margin-bottom:0}}@media screen and (min-width:760px){.page-header .mobile-toggle{display:none}.page-header .mobile-menu{flex:1}.page-header nav{flex:1}.page-header nav header{display:none}.page-header ul{list-style-type:none}.page-header nav ul{display:flex;align-items:end;justify-content:flex-end;flex-direction:row}.page-header nav li{padding-left:1.5rem}.page-header nav li.active a{border-bottom-width:3px;border-bottom-color:#6761a8}}@media screen{.page-header{position:relative;max-width:1400px;margin-left:auto;margin-right:auto;padding-left:1.5rem;padding-right:1.5rem;height:3rem;display:flex;flex-direction:row}}@media print{header.page{display:none}}@media screen and (max-width:759px) and (prefers-reduced-motion:reduce){.mobile-menu{transition:none}#show-mobile-menu+.mobile-toggle .hamburger-bar{transition:none}}@media screen and (max-width:759px) and (prefers-reduced-transparency:reduce){.mobile-menu{background:gray}}html,body{font-family:Arial,sans-serif;scroll-behavior:smooth;text-rendering:optimizeSpeed;-webkit-font-smoothing:antialiased;line-height:1.5rem;font-feature-settings:"liga" 1;font-weight:500;font-size:18px}@media(min-width:900px){html,body{font-size:20px}}@media(min-width:1100px){html,body{font-size:22px}}@media(min-width:1800px){html,body{font-size:24px}}@media print{html,body{font-size:18px}}hr{border:0;height:2px;background-color:#fe7f2d;margin-top:1.5rem;margin-bottom:1.5rem}.text{position:relative}.text .meta{font-variant:small-caps}.text .meta .byline{display:none}.text .meta .line{display:inline-block}.text .meta .calendar{display:none}.text h1,.text h2,.text h3,.text h4,.text h5,.text h6{font-family:Georgia,palatino linotype,book antiqua,Palatino,times new roman,serif;font-weight:500;page-break-after:avoid}.text h1 a,.text h1 a:visited,.text h2 a,.text h2 a:visited,.text h3 a,.text h3 a:visited,.text h4 a,.text h4 a:visited,.text h5 a,.text h5 a:visited,.text h6 a,.text h6 a:visited{color:#2a2d34;text-decoration:none}.text p,.text ul,.text ol,.text figure,.text dl,.text hr{margin-top:1.5rem;font-size:1rem}.text q{font-style:italic}.text ul ul{margin-top:0}.text p>code,.text ul>code,.text ol>code,.text dt>code,.text dd>code,.text li>code{color:#009b72}.text button{cursor:pointer;display:inline-block;box-sizing:border-box;border:.1rem solid #6761a8;height:1.5rem;padding-left:.75rem;padding-right:.75rem;border-radius:.2rem;transition:color .233s ease-in-out,background-color .233s ease-in-out}.text button:hover{color:#fff;background-color:#6761a8}.text audio{display:block;width:100%;height:1.5rem;outline:none}.text audio span{line-height:1.5rem}.text dl{overflow:auto;position:relative}.text dt{font-weight:700}.text dd{padding-left:2rem}.text dd+dt{margin-top:1.5rem}.text ul{list-style-type:disc;padding-left:1.5rem}.text ol{list-style-type:decimal;padding-left:1.5rem}.text p{overflow-wrap:break-word;word-wrap:break-word;-webkit-hyphens:auto;-moz-hyphens:auto;-ms-hyphens:auto;hyphens:auto}.text h1{font-size:2.5rem;font-weight:500;line-height:3rem;margin-top:1.5rem;margin-bottom:0}@media screen and (min-width:760px){.text h1{font-size:3.5rem;line-height:4.5rem;margin-top:1.5rem}}@media screen and (min-width:900px){.text h1{font-size:4rem;line-height:4.5rem;margin-top:3rem}}@media screen and (min-width:1400px){.text h1{font-size:5rem;line-height:6rem;margin-top:6rem}}.text h2{font-size:2rem;line-height:3rem;margin-top:3rem;margin-bottom:3rem}.text h3{font-size:1.5rem;line-height:1.5rem;margin-top:1.5rem;margin-bottom:1.5rem}.text h4{font-size:1rem;line-height:1.5rem;margin-top:1.5rem;margin-bottom:1.5rem}.text h5{font-size:.8rem;line-height:1.5rem;margin-top:1.5rem;margin-bottom:1.5rem}.text h6{font-size:.6rem;line-height:1.5rem;margin-top:1.5rem;margin-bottom:1.5rem}.text strong{font-weight:700}.text em{font-style:italic}.text blockquote{border-left:.2rem solid #999;padding-left:.75rem}.text code{font-family:lucida console,Monaco,monospace;speak:literal-punctuation}.text abbr,.text acronym{speak:spell-out}.text del{text-decoration:line-through}.text ins{text-decoration:none;font-style:italic}.text figure{position:relative;text-align:center}.text figure img{background:#fff;border-radius:.2rem;max-width:100%}.text figure table{min-width:75%;border-radius:.2rem;margin-left:auto;margin-right:auto;border:#6761a8;border-collapse:separate;border-spacing:0;background:#fff;margin-bottom:-.1em}.text figure table th,.text figure table td{padding-left:.75rem;padding-right:.75rem;line-height:1.3rem;border-left:.1rem solid #6761a8;border-top:.1rem solid #6761a8}.text figure table thead{background-color:#fff}.text figure table tr td:last-child,.text figure table tr th:last-child{border-right:.1rem solid #6761a8}.text figure table tbody:last-child tr:last-child td{border-bottom:.1rem solid #6761a8}.text figure table thead:first-child tr:first-child th:first-child,.text figure table thead:first-child tr:first-child td:first-child{border-top-left-radius:.2rem}.text figure table thead:first-child tr:first-child,.text figure table thead:first-child tr:first-child th:last-child,.text figure table thead:first-child tr:first-child td:last-child{border-top-right-radius:.2rem}.text figure table tbody:last-child tr:last-child,.text figure table tbody:last-child tr:last-child td:first-child{border-bottom-left-radius:.2rem}.text figure table tbody:last-child tr:last-child,.text figure table tbody:last-child tr:last-child td:last-child{border-bottom-right-radius:.2rem}.text figure ul{text-align:left}.text figure ul.tree{padding-top:1.5em;padding-bottom:1.5em;border-radius:.2rem;background:#fff}.text figure ul.tree li{list-style-type:none}.text figure ul.tree .tree__item--folder::before{content:"üìÅ";margin-right:.2em}.text figure ul.tree .tree__item--file::before{content:"üìù";margin-right:.2em}.text figure figcaption{font-style:italic}.text pre{margin-top:1.5rem;font-size:inherit;line-height:1.5rem;padding:1.5rem 1.5rem .75rem;white-space:pre;overflow-x:scroll;overflow-y:hidden;scrollbar-color:#cccccc transparent;scrollbar-width:.75rem}.text pre::-webkit-scrollbar{margin-top:-.75rem;height:.75rem}.text pre::-webkit-scrollbar-track{background:0 0}.text pre::-webkit-scrollbar-thumb{height:.1rem;border-radius:.2rem;background:#ccc}.text hr{border:0;height:.2rem;background:#6761a8;margin-top:1.3rem}.text .admonition{position:relative}.text .admonition>*{padding-left:2rem}.text .admonition>:first-child::before{display:block;text-align:left;position:absolute;top:0;left:0;width:.75rem;font-size:1rem;line-height:1.5rem;height:1.5rem}.text .admonition--tip>:first-child::before{content:"‚òõ";color:#00a000;font-size:1.5rem;line-height:1.5rem;height:1.5rem}.text .admonition--warning>:first-child::before{content:"‚ö†Ô∏è";color:#fe7f2d}.text .admonition--info>:first-child::before{content:"‚ìò";color:#004966;font-weight:700}@media print{.text h1{margin-left:auto;margin-right:auto;margin-top:9rem;width:80%;font-variant:small-caps;text-align:center}.text--simple h1{margin-top:0}.text .meta{page-break-after:always;text-align:center;font-size:1.2rem;margin-top:1.5rem}.text .meta a{text-decoration:none}.text .meta time{display:none}.text .body p:first-of-type{margin-top:0}.text pre{padding:0;font-size:inherit;line-height:1.5rem;overflow:hidden;white-space:pre-wrap;word-break:break-all}}.text .podcasts{margin-top:1.5rem;text-align:center}.text a.podcast{display:block;height:3rem}.text a.podcast img{width:50%;max-width:200px}@media screen and (min-width:768px){.text .podcasts{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));grid-gap:1.5rem}.text a.podcast img{width:100%}}.text .tombstone{opacity:0}html,body{min-height:100vh}body{text-align:center}@media screen{body{color:#2a2d34;background-color:#fefefe}}@media print{body{color:#000;background:#fff}}@media screen{body{display:flex;flex-direction:column}main.page{width:100%;flex:1}}header.page,main.page,footer.page{text-align:left}.page-main,.contentblock{max-width:1400px;padding-left:1.5rem;padding-right:1.5rem;margin-left:auto;margin-right:auto}@media print{.page-main,.contentblock{padding:0}}@page{size:A4;padding:0;margin:3rem}.highlight{color:#6761a8}.nobr{white-space:nowrap}.aria-only{display:none}@media aural{.aria-only{display:block}}a{color:#004966;text-decoration-color:#a2dffb;transition:color .233s ease-out,text-decoration-color .233s ease-out}a:hover,a:visited:hover{color:#fe7f2d}a:active{color:#fe7f2d}a:visited{color:#6761a8;text-decoration-color:#009b72}footer.page{margin-top:1.5rem}footer.page h2{font-size:1rem}@media not print{footer.page{margin-top:1.5rem/2;padding-top:1.5rem/2;padding-bottom:1.5rem/2}.page-footer{max-width:1400px;padding-left:1.5rem;padding-right:1.5rem;margin-left:auto;margin-right:auto;font-size:.7rem;line-height:1.5rem}}@media not print{.page-footer ul{margin-bottom:1.5rem}.page-footer a{display:block;text-decoration:none;height:2.6rem;line-height:2.6rem;border-top:.2rem solid transparent;border-bottom:.2rem solid transparent}.page-footer a,.page-footer a span{transition:color .233s ease-in-out,border-bottom .233s,margin-bottom .233s}.page-footer a:hover{color:#004966;border-bottom:.2rem solid #004966}.page-footer a:hover span{color:#004966}.page-footer a img{height:2.6rem}.page-footer nav ul{display:flex;flex-direction:row;align-items:center;justify-content:center;margin-bottom:0;height:1.5rem;line-height:1.5rem}.page-footer nav ul a{height:1.3rem;line-height:1.3rem;text-align:center;display:block;padding-left:.75rem;padding-right:.75rem;border-bottom:.2rem solid transparent}}@media print{footer.page nav{display:none}footer.page aside{border-top:.2rem solid #333;margin-top:.65rem;padding-top:.65rem}}footer.page{border-top:2px solid #fe7f2d;margin-top:-2px}footer.page aside{text-align:center;font-size:.6rem;line-height:1.5rem;color:#333}@media screen{footer.page{background-color:#fefefe}.page-footer a{color:#2a2d34;border-bottom:0 solid #fefefe}.page-footer a:hover{color:#004966;border-bottom-color:#004966}.page-footer a:visited{color:#2a2d34}}.grid{display:grid;gap:1.5rem 1.5rem;font-size:.9rem;margin-bottom:1.5rem;margin-top:1.5rem}.grid--2{grid-template-columns:1fr 1fr}.grid--3{grid-template-columns:1fr 1fr 1fr}.grid--4{grid-template-columns:1fr 1fr 1fr}.grid img{max-width:100%}.grid h2{font-size:1.2rem;margin-bottom:.75rem}.grid p{margin-bottom:.75rem}@media(max-width:768px){.grid--2{display:block}}@media(max-width:1200px){.grid--3{display:block}}@media(max-width:1600px){.grid--4{display:block}}.post--preview{display:block;border-radius:.3rem;padding-bottom:.375rem}.post--preview img{margin-bottom:.375rem}.post--preview h2,.post--preview p{padding-left:.5rem;padding-right:.5rem}.post--preview :last-child{margin-bottom:0}.post--preview:hover{box-shadow:0 0 1.5rem #666666}a.post--preview,a.post--preview *{text-decoration:none;color:#2a2d34}a.post--preview .readmore,a.post--preview * .readmore{font-weight:700}.hero{background-color:#004966;background-position:50%;background-repeat:no-repeat;background-size:cover;color:#fff}.hero h1{margin-bottom:1.5rem}.hero a{color:#fff;font-weight:700;border-bottom:2px solid #fff;text-decoration:none;transition:color .233s ease-out,border-bottom-color .233s ease-out}.hero a:hover,.hero a:visited:hover{color:#fff;border-bottom-color:#fe7f2d}.hero img{float:left;margin-right:1.5rem}.hero:nth-child(4n+2),.hero:nth-child(4n+4){background-color:initial;color:#2a2d34}.hero:nth-child(4n+2) img,.hero:nth-child(4n+4) img{float:right;margin-right:0;margin-left:1.5rem}.hero:nth-child(4n+2) a,.hero:nth-child(4n+4) a{color:#2a2d34}.hero:nth-child(4n+2) a:hover,.hero:nth-child(4n+4) a:hover{color:#2a2d34}.hero:nth-child(4n+3){background-color:#fe7f2d}.hero--bio .contentblock{text-align:center}.hero--bio .contentblock img{text-align:center;float:none;margin-bottom:1.5rem}.hero--bio .contentblock p{text-align:left}@media(min-width:769px){.hero--bio .contentblock{min-height:240px;text-align:left}.hero--bio .contentblock img{float:right;margin-left:1.5rem;margin-bottom:0}}.contentblock{padding-top:3rem;padding-bottom:3rem}.herotext{font-size:1.2rem;background:rgba(0,0,0,.5);padding:1.5rem;border-radius:.75rem}.herotext p{margin-top:1.5rem}.herotext p:first-child{margin-top:0}.herotext small{font-size:.8rem}html,body{font-family:Arial,sans-serif;scroll-behavior:smooth;text-rendering:optimizeSpeed;-webkit-font-smoothing:antialiased;line-height:1.5rem;font-feature-settings:"liga" 1;font-weight:500;font-size:18px}@media(min-width:900px){html,body{font-size:20px}}@media(min-width:1100px){html,body{font-size:22px}}@media(min-width:1800px){html,body{font-size:24px}}@media print{html,body{font-size:18px}}hr{border:0;height:2px;background-color:#fe7f2d;margin-top:1.5rem;margin-bottom:1.5rem}.text{position:relative}.text .meta{font-variant:small-caps}.text .meta .byline{display:none}.text .meta .line{display:inline-block}.text .meta .calendar{display:none}.text h1,.text h2,.text h3,.text h4,.text h5,.text h6{font-family:Georgia,palatino linotype,book antiqua,Palatino,times new roman,serif;font-weight:500;page-break-after:avoid}.text h1 a,.text h1 a:visited,.text h2 a,.text h2 a:visited,.text h3 a,.text h3 a:visited,.text h4 a,.text h4 a:visited,.text h5 a,.text h5 a:visited,.text h6 a,.text h6 a:visited{color:#2a2d34;text-decoration:none}.text p,.text ul,.text ol,.text figure,.text dl,.text hr{margin-top:1.5rem;font-size:1rem}.text q{font-style:italic}.text ul ul{margin-top:0}.text p>code,.text ul>code,.text ol>code,.text dt>code,.text dd>code,.text li>code{color:#009b72}.text button{cursor:pointer;display:inline-block;box-sizing:border-box;border:.1rem solid #6761a8;height:1.5rem;padding-left:.75rem;padding-right:.75rem;border-radius:.2rem;transition:color .233s ease-in-out,background-color .233s ease-in-out}.text button:hover{color:#fff;background-color:#6761a8}.text audio{display:block;width:100%;height:1.5rem;outline:none}.text audio span{line-height:1.5rem}.text dl{overflow:auto;position:relative}.text dt{font-weight:700}.text dd{padding-left:2rem}.text dd+dt{margin-top:1.5rem}.text ul{list-style-type:disc;padding-left:1.5rem}.text ol{list-style-type:decimal;padding-left:1.5rem}.text p{overflow-wrap:break-word;word-wrap:break-word;-webkit-hyphens:auto;-moz-hyphens:auto;-ms-hyphens:auto;hyphens:auto}.text h1{font-size:2.5rem;font-weight:500;line-height:3rem;margin-top:1.5rem;margin-bottom:0}@media screen and (min-width:760px){.text h1{font-size:3.5rem;line-height:4.5rem;margin-top:1.5rem}}@media screen and (min-width:900px){.text h1{font-size:4rem;line-height:4.5rem;margin-top:3rem}}@media screen and (min-width:1400px){.text h1{font-size:5rem;line-height:6rem;margin-top:6rem}}.text h2{font-size:2rem;line-height:3rem;margin-top:3rem;margin-bottom:3rem}.text h3{font-size:1.5rem;line-height:1.5rem;margin-top:1.5rem;margin-bottom:1.5rem}.text h4{font-size:1rem;line-height:1.5rem;margin-top:1.5rem;margin-bottom:1.5rem}.text h5{font-size:.8rem;line-height:1.5rem;margin-top:1.5rem;margin-bottom:1.5rem}.text h6{font-size:.6rem;line-height:1.5rem;margin-top:1.5rem;margin-bottom:1.5rem}.text strong{font-weight:700}.text em{font-style:italic}.text blockquote{border-left:.2rem solid #999;padding-left:.75rem}.text code{font-family:lucida console,Monaco,monospace;speak:literal-punctuation}.text abbr,.text acronym{speak:spell-out}.text del{text-decoration:line-through}.text ins{text-decoration:none;font-style:italic}.text figure{position:relative;text-align:center}.text figure img{background:#fff;border-radius:.2rem;max-width:100%}.text figure table{min-width:75%;border-radius:.2rem;margin-left:auto;margin-right:auto;border:#6761a8;border-collapse:separate;border-spacing:0;background:#fff;margin-bottom:-.1em}.text figure table th,.text figure table td{padding-left:.75rem;padding-right:.75rem;line-height:1.3rem;border-left:.1rem solid #6761a8;border-top:.1rem solid #6761a8}.text figure table thead{background-color:#fff}.text figure table tr td:last-child,.text figure table tr th:last-child{border-right:.1rem solid #6761a8}.text figure table tbody:last-child tr:last-child td{border-bottom:.1rem solid #6761a8}.text figure table thead:first-child tr:first-child th:first-child,.text figure table thead:first-child tr:first-child td:first-child{border-top-left-radius:.2rem}.text figure table thead:first-child tr:first-child,.text figure table thead:first-child tr:first-child th:last-child,.text figure table thead:first-child tr:first-child td:last-child{border-top-right-radius:.2rem}.text figure table tbody:last-child tr:last-child,.text figure table tbody:last-child tr:last-child td:first-child{border-bottom-left-radius:.2rem}.text figure table tbody:last-child tr:last-child,.text figure table tbody:last-child tr:last-child td:last-child{border-bottom-right-radius:.2rem}.text figure ul{text-align:left}.text figure ul.tree{padding-top:1.5em;padding-bottom:1.5em;border-radius:.2rem;background:#fff}.text figure ul.tree li{list-style-type:none}.text figure ul.tree .tree__item--folder::before{content:"üìÅ";margin-right:.2em}.text figure ul.tree .tree__item--file::before{content:"üìù";margin-right:.2em}.text figure figcaption{font-style:italic}.text pre{margin-top:1.5rem;font-size:inherit;line-height:1.5rem;padding:1.5rem 1.5rem .75rem;white-space:pre;overflow-x:scroll;overflow-y:hidden;scrollbar-color:#cccccc transparent;scrollbar-width:.75rem}.text pre::-webkit-scrollbar{margin-top:-.75rem;height:.75rem}.text pre::-webkit-scrollbar-track{background:0 0}.text pre::-webkit-scrollbar-thumb{height:.1rem;border-radius:.2rem;background:#ccc}.text hr{border:0;height:.2rem;background:#6761a8;margin-top:1.3rem}.text .admonition{position:relative}.text .admonition>*{padding-left:2rem}.text .admonition>:first-child::before{display:block;text-align:left;position:absolute;top:0;left:0;width:.75rem;font-size:1rem;line-height:1.5rem;height:1.5rem}.text .admonition--tip>:first-child::before{content:"‚òõ";color:#00a000;font-size:1.5rem;line-height:1.5rem;height:1.5rem}.text .admonition--warning>:first-child::before{content:"‚ö†Ô∏è";color:#fe7f2d}.text .admonition--info>:first-child::before{content:"‚ìò";color:#004966;font-weight:700}@media print{.text h1{margin-left:auto;margin-right:auto;margin-top:9rem;width:80%;font-variant:small-caps;text-align:center}.text--simple h1{margin-top:0}.text .meta{page-break-after:always;text-align:center;font-size:1.2rem;margin-top:1.5rem}.text .meta a{text-decoration:none}.text .meta time{display:none}.text .body p:first-of-type{margin-top:0}.text pre{padding:0;font-size:inherit;line-height:1.5rem;overflow:hidden;white-space:pre-wrap;word-break:break-all}}.text .podcasts{margin-top:1.5rem;text-align:center}.text a.podcast{display:block;height:3rem}.text a.podcast img{width:50%;max-width:200px}@media screen and (min-width:768px){.text .podcasts{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));grid-gap:1.5rem}.text a.podcast img{width:100%}}.text .tombstone{opacity:0}.paginator{margin-top:1.5rem;text-align:center}.paginator a{display:inline-block;text-decoration:none;border-radius:3px;color:#2a2d34;border:1px solid #2a2d34;transition:.2s background-color ease-in-out,.2s color ease-in-out,.2s border-color ease-in-out;height:1rem;width:1rem;line-height:1rem;font-size:.7rem;margin-left:.2rem;margin-right:.2rem}.paginator a:hover,.paginator a.active{background:#004966;color:#fefefe;border:1px solid #004966}@media screen and (min-width:768px){.paginator a{height:1.5rem;width:1.5rem;line-height:1.5rem;font-size:1rem}}@media screen and (min-width:900px){.paginator a{height:3rem;width:3rem;line-height:3rem;font-size:1.2rem}}html,body{font-family:Arial,sans-serif;scroll-behavior:smooth;text-rendering:optimizeSpeed;-webkit-font-smoothing:antialiased;line-height:1.5rem;font-feature-settings:"liga" 1;font-weight:500;font-size:18px}@media(min-width:900px){html,body{font-size:20px}}@media(min-width:1100px){html,body{font-size:22px}}@media(min-width:1800px){html,body{font-size:24px}}@media print{html,body{font-size:18px}}hr{border:0;height:2px;background-color:#fe7f2d;margin-top:1.5rem;margin-bottom:1.5rem}.text{position:relative}.text .meta{font-variant:small-caps}.text .meta .byline{display:none}.text .meta .line{display:inline-block}.text .meta .calendar{display:none}.text h1,.text h2,.text h3,.text h4,.text h5,.text h6{font-family:Georgia,palatino linotype,book antiqua,Palatino,times new roman,serif;font-weight:500;page-break-after:avoid}.text h1 a,.text h1 a:visited,.text h2 a,.text h2 a:visited,.text h3 a,.text h3 a:visited,.text h4 a,.text h4 a:visited,.text h5 a,.text h5 a:visited,.text h6 a,.text h6 a:visited{color:#2a2d34;text-decoration:none}.text p,.text ul,.text ol,.text figure,.text dl,.text hr{margin-top:1.5rem;font-size:1rem}.text q{font-style:italic}.text ul ul{margin-top:0}.text p>code,.text ul>code,.text ol>code,.text dt>code,.text dd>code,.text li>code{color:#009b72}.text button{cursor:pointer;display:inline-block;box-sizing:border-box;border:.1rem solid #6761a8;height:1.5rem;padding-left:.75rem;padding-right:.75rem;border-radius:.2rem;transition:color .233s ease-in-out,background-color .233s ease-in-out}.text button:hover{color:#fff;background-color:#6761a8}.text audio{display:block;width:100%;height:1.5rem;outline:none}.text audio span{line-height:1.5rem}.text dl{overflow:auto;position:relative}.text dt{font-weight:700}.text dd{padding-left:2rem}.text dd+dt{margin-top:1.5rem}.text ul{list-style-type:disc;padding-left:1.5rem}.text ol{list-style-type:decimal;padding-left:1.5rem}.text p{overflow-wrap:break-word;word-wrap:break-word;-webkit-hyphens:auto;-moz-hyphens:auto;-ms-hyphens:auto;hyphens:auto}.text h1{font-size:2.5rem;font-weight:500;line-height:3rem;margin-top:1.5rem;margin-bottom:0}@media screen and (min-width:760px){.text h1{font-size:3.5rem;line-height:4.5rem;margin-top:1.5rem}}@media screen and (min-width:900px){.text h1{font-size:4rem;line-height:4.5rem;margin-top:3rem}}@media screen and (min-width:1400px){.text h1{font-size:5rem;line-height:6rem;margin-top:6rem}}.text h2{font-size:2rem;line-height:3rem;margin-top:3rem;margin-bottom:3rem}.text h3{font-size:1.5rem;line-height:1.5rem;margin-top:1.5rem;margin-bottom:1.5rem}.text h4{font-size:1rem;line-height:1.5rem;margin-top:1.5rem;margin-bottom:1.5rem}.text h5{font-size:.8rem;line-height:1.5rem;margin-top:1.5rem;margin-bottom:1.5rem}.text h6{font-size:.6rem;line-height:1.5rem;margin-top:1.5rem;margin-bottom:1.5rem}.text strong{font-weight:700}.text em{font-style:italic}.text blockquote{border-left:.2rem solid #999;padding-left:.75rem}.text code{font-family:lucida console,Monaco,monospace;speak:literal-punctuation}.text abbr,.text acronym{speak:spell-out}.text del{text-decoration:line-through}.text ins{text-decoration:none;font-style:italic}.text figure{position:relative;text-align:center}.text figure img{background:#fff;border-radius:.2rem;max-width:100%}.text figure table{min-width:75%;border-radius:.2rem;margin-left:auto;margin-right:auto;border:#6761a8;border-collapse:separate;border-spacing:0;background:#fff;margin-bottom:-.1em}.text figure table th,.text figure table td{padding-left:.75rem;padding-right:.75rem;line-height:1.3rem;border-left:.1rem solid #6761a8;border-top:.1rem solid #6761a8}.text figure table thead{background-color:#fff}.text figure table tr td:last-child,.text figure table tr th:last-child{border-right:.1rem solid #6761a8}.text figure table tbody:last-child tr:last-child td{border-bottom:.1rem solid #6761a8}.text figure table thead:first-child tr:first-child th:first-child,.text figure table thead:first-child tr:first-child td:first-child{border-top-left-radius:.2rem}.text figure table thead:first-child tr:first-child,.text figure table thead:first-child tr:first-child th:last-child,.text figure table thead:first-child tr:first-child td:last-child{border-top-right-radius:.2rem}.text figure table tbody:last-child tr:last-child,.text figure table tbody:last-child tr:last-child td:first-child{border-bottom-left-radius:.2rem}.text figure table tbody:last-child tr:last-child,.text figure table tbody:last-child tr:last-child td:last-child{border-bottom-right-radius:.2rem}.text figure ul{text-align:left}.text figure ul.tree{padding-top:1.5em;padding-bottom:1.5em;border-radius:.2rem;background:#fff}.text figure ul.tree li{list-style-type:none}.text figure ul.tree .tree__item--folder::before{content:"üìÅ";margin-right:.2em}.text figure ul.tree .tree__item--file::before{content:"üìù";margin-right:.2em}.text figure figcaption{font-style:italic}.text pre{margin-top:1.5rem;font-size:inherit;line-height:1.5rem;padding:1.5rem 1.5rem .75rem;white-space:pre;overflow-x:scroll;overflow-y:hidden;scrollbar-color:#cccccc transparent;scrollbar-width:.75rem}.text pre::-webkit-scrollbar{margin-top:-.75rem;height:.75rem}.text pre::-webkit-scrollbar-track{background:0 0}.text pre::-webkit-scrollbar-thumb{height:.1rem;border-radius:.2rem;background:#ccc}.text hr{border:0;height:.2rem;background:#6761a8;margin-top:1.3rem}.text .admonition{position:relative}.text .admonition>*{padding-left:2rem}.text .admonition>:first-child::before{display:block;text-align:left;position:absolute;top:0;left:0;width:.75rem;font-size:1rem;line-height:1.5rem;height:1.5rem}.text .admonition--tip>:first-child::before{content:"‚òõ";color:#00a000;font-size:1.5rem;line-height:1.5rem;height:1.5rem}.text .admonition--warning>:first-child::before{content:"‚ö†Ô∏è";color:#fe7f2d}.text .admonition--info>:first-child::before{content:"‚ìò";color:#004966;font-weight:700}@media print{.text h1{margin-left:auto;margin-right:auto;margin-top:9rem;width:80%;font-variant:small-caps;text-align:center}.text--simple h1{margin-top:0}.text .meta{page-break-after:always;text-align:center;font-size:1.2rem;margin-top:1.5rem}.text .meta a{text-decoration:none}.text .meta time{display:none}.text .body p:first-of-type{margin-top:0}.text pre{padding:0;font-size:inherit;line-height:1.5rem;overflow:hidden;white-space:pre-wrap;word-break:break-all}}.text .podcasts{margin-top:1.5rem;text-align:center}.text a.podcast{display:block;height:3rem}.text a.podcast img{width:50%;max-width:200px}@media screen and (min-width:768px){.text .podcasts{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));grid-gap:1.5rem}.text a.podcast img{width:100%}}.text .tombstone{opacity:0}.text .chroma{font-size:.8rem;border-radius:.2rem}.text .chroma .lntd{vertical-align:top;padding:0;margin:0;border:0}.text .chroma .lntable{border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block}.text .chroma .hl{display:block;width:100%}.text .chroma .lnt{margin-right:.4em;padding:0 .4em}.text .chroma{color:#272822}@media screen{.text .chroma{background-color:#fafafa}}.text .chroma .err{color:#960050}.text .chroma .hl{background-color:#ffc}.text .chroma .lnt{margin-right:.4em;padding:0 .4em;color:#7f7f7f}.text .chroma .ln{color:#7f7f7f}.text .chroma .k{color:#00a8c8}.text .chroma .kc{color:#00a8c8}.text .chroma .kd{color:#00a8c8}.text .chroma .kn{color:#f92672}.text .chroma .kp{color:#00a8c8}.text .chroma .kr{color:#00a8c8}.text .chroma .kt{color:#00a8c8}.text .chroma .n{color:#111}.text .chroma .na{color:#75af00}.text .chroma .nb{color:#111}.text .chroma .bp{color:#111}.text .chroma .nc{color:#75af00}.text .chroma .no{color:#00a8c8}.text .chroma .nd{color:#75af00}.text .chroma .ni{color:#111}.text .chroma .ne{color:#75af00}.text .chroma .nf{color:#75af00}.text .chroma .fm{color:#111}.text .chroma .nl{color:#111}.text .chroma .nn{color:#111}.text .chroma .nx{color:#75af00}.text .chroma .py{color:#111}.text .chroma .nt{color:#f92672}.text .chroma .nv{color:#111}.text .chroma .vc{color:#111}.text .chroma .vg{color:#111}.text .chroma .vi{color:#111}.text .chroma .vm{color:#111}.text .chroma .l{color:#ae81ff}.text .chroma .ld{color:#d88200}.text .chroma .s{color:#d88200}.text .chroma .sa{color:#d88200}.text .chroma .sb{color:#d88200}.text .chroma .sc{color:#d88200}.text .chroma .dl{color:#d88200}.text .chroma .sd{color:#d88200}.text .chroma .s2{color:#d88200}.text .chroma .se{color:#8045ff}.text .chroma .sh{color:#d88200}.text .chroma .si{color:#d88200}.text .chroma .sx{color:#d88200}.text .chroma .sr{color:#d88200}.text .chroma .s1{color:#d88200}.text .chroma .ss{color:#d88200}.text .chroma .m{color:#ae81ff}.text .chroma .mb{color:#ae81ff}.text .chroma .mf{color:#ae81ff}.text .chroma .mh{color:#ae81ff}.text .chroma .mi{color:#ae81ff}.text .chroma .il{color:#ae81ff}.text .chroma .mo{color:#ae81ff}.text .chroma .o{color:#f92672}.text .chroma .ow{color:#f92672}.text .chroma .p{color:#111}.text .chroma .c{color:#75715e}.text .chroma .ch{color:#75715e}.text .chroma .cm{color:#75715e}.text .chroma .c1{color:#75715e}.text .chroma .cs{color:#75715e}.text .chroma .cp{color:#75715e}.text .chroma .cpf{color:#75715e}.text .chroma .ge{font-style:italic}.text .chroma .gs{font-weight:700}</style><meta name=color-scheme content="dark light"></head><body><header><div class=page-header><div class=logo><a href=/><img src="data:image/svg+xml,%3Csvg baseProfile=%22tiny%22 id=%22Capa_1%22 xmlns=%22http://www.w3.org/2000/svg%22 xmlns:xlink=%22http://www.w3.org/1999/xlink%22 viewBox=%220 0 650 210%22%3E%3Cg%3E%3Cg%3E%3Ccircle fill=%22%23fff%22 cx=%22100.91%22 cy=%22104.98%22 r=%2268.91%22/%3E%3Cg%3E%3Cpath fill=%22%23bf181a%22 d=%22M100.91 36.12C62.85 36.12 32 66.97 32 105.03c0 23.47 11.74 44.18 29.66 56.63v-56.63c0-21.68 17.57-39.25 39.25-39.25s39.25 17.57 39.25 39.25-17.57 39.25-39.25 39.25c-8.76.0-16.82-2.91-23.35-7.76v33.35c7.29 2.63 15.15 4.07 23.35 4.07 38.06.0 68.91-30.85 68.91-68.91s-30.86-68.91-68.91-68.91z%22/%3E%3Ccircle fill=%22%23efc700%22 cx=%22100.91%22 cy=%22105.03%22 r=%2222.96%22/%3E%3Cpath fill=%22%23e6b600%22 d=%22M100.91 84.32c12.3.0 22.31 9.68 22.9 21.83.02-.38.06-.75.06-1.13.0-12.68-10.28-22.96-22.96-22.96s-22.96 10.28-22.96 22.96c0 .38.04.75.06 1.13C78.6 94 88.61 84.32 100.91 84.32z%22/%3E%3C/g%3E%3C/g%3E%3Cpath fill=%22%233c3c3c%22 d=%22M213.3 128.11V81.98h19.29c10.51.0 17.3 6.16 17.3 15.7.0 9.39-7.11 15.95-17.3 15.95h-9.02v14.47H213.3zm18.71-23.13c4.84.0 7.61-2.66 7.61-7.29.0-4.54-2.7-7.04-7.61-7.04h-8.45v14.33H232.01z%22/%3E%3Cpolygon fill=%22%233c3c3c%22 points=%22272.12,128.11 272.12,81.98 304.8,81.98 304.8,90.71 282.39,90.71 282.39,100.36 302.88,100.36 302.88,109.15 282.39,109.15 282.39,119.38 304.87,119.38 304.87,128.11%22/%3E%3Cpath fill=%22%233c3c3c%22 d=%22M354.71 128.11l-8.2-14.35h-8.39v14.35h-10.26V81.98h20.89c10.24.0 16.85 6.24 16.85 15.89.0 6.29-3.19 11.52-8.56 14.12l9.56 16.11H354.71zM347.66 105.23c4.81.0 7.68-2.77 7.68-7.42.0-4.59-2.8-7.23-7.68-7.23h-9.53v14.65H347.66z%22/%3E%3Cpath fill=%22%233c3c3c%22 d=%22M470.47 129.01c-12.53.0-20.63-8.12-20.63-20.69v-6.53c0-12.57 8.1-20.69 20.63-20.69 12.72.0 20.63 7.93 20.63 20.69v6.53C491.1 121.08 483.19 129.01 470.47 129.01zm0-39.2c-6.59.0-10.37 4.2-10.37 11.52v7.43c0 7.32 3.78 11.52 10.37 11.52 6.59.0 10.36-4.2 10.36-11.52v-7.43C480.83 94.01 477.06 89.81 470.47 89.81z%22/%3E%3Cpolygon fill=%22%233c3c3c%22 points=%22543.01,128.11 524.48,99.79 524.48,128.11 514.41,128.11 514.41,81.98 523.93,81.98 542.46,110.3 542.46,81.98 552.53,81.98 552.53,128.11%22/%3E%3Cpath fill=%22%233c3c3c%22 d=%22M607.7 128.11l-3.01-9.41h-16.47l-3.01 9.41h-10.29l16.54-46.13h10.01L618 128.11H607.7zM601.98 110.29l-5.52-17.45-5.58 17.45h11.1z%22/%3E%3Cg%3E%3Cpath fill=%22%233c3c3c%22 d=%22M418.62 111.85c-.77 5.33-4.37 8.5-9.73 8.5-8.74.0-10.05-7.3-10.05-11.65v-7.3c0-4.35 1.31-11.65 10.05-11.65 5.35.0 8.95 3.15 9.73 8.45l9.52-1.42c-1.28-9.33-8.95-15.7-19.24-15.7-12.68.0-20.24 7.76-20.24 20.76v6.4c0 13 7.57 20.76 20.24 20.76 10.3.0 17.98-6.39 19.25-15.74L418.62 111.85z%22/%3E%3C/g%3E%3C/g%3E%3C/svg%3E" alt=Percona></a></div><input type=checkbox id=show-mobile-menu value=1 aria-hidden=true><div class=mobile-toggle aria-controls=mobile-menu aria-label="Open navigation" role=button><label for=show-mobile-menu id=hamburger><span class=hamburger-bar></span><span class=hamburger-bar></span><span class=hamburger-bar></span></label></div><div class=mobile-menu id=mobile-menu aria-labelledby=navigation-header role=dialog aria-modal=false aria-hidden=true><nav><ul><li><a href=/blog><span>Blog</span></a></li><li><a href=/resources><span>Resources</span></a></li><li><a href=/projects><span>Projects</span></a></li><li><a href=/contribute><span>Contribute</span></a></li></ul></nav></div></div></header><main class=page><div class=page-main><article class=text itemscope itemtype=https://schema.org/BlogPosting><meta itemprop=image content="https://percona.community/blog/2020/01/ricardo-gomez-angel-87vUJY3ntyI-unsplash.jpg"><meta itemprop=mainEntityOfPage content="https://percona.community/blog/2020-02-05-finding-mysql-scaling-problems-using-perf/"><meta itemprop=keywords content="author.daniel, cacheline, MariaDB, MySQL, perf, performance, POWER"><h1 itemprop="name headline">Finding MySQL Scaling Problems Using perf</h1><div class=meta><time datetime="2020-02-05 16:18:14 +0000 UTC" itemprop=datePublished><span class=line>February 5, 2020</span>
<span class=calendar><span class=day>5</span>
<span class=month-year>Feb 2020</span></span></time>
<span class=authors>by <a href=/authors/daniel_black/>Daniel Black</a></span></div><div itemprop=articleBody class=body><p>The thing I wish I&rsquo;d learned while still a DBA is how to use <a href=https://perf.wiki.kernel.org/index.php/Main_Page target=_blank rel="noopener noreferrer">perf</a>. Conversely after moving to a developer role, getting access to real external client workloads to get a perf recording directly is rare. To bridge this gap, I hope to encourage a bit of perf usage to help DBAs report bugs/feature requests in more detail to MySQL developers, who can then serve your needs better.</p><p><figure><img sizes=100vw srcset="/blog/2020/01/ricardo-gomez-angel-87vUJY3ntyI-unsplash_hu98532f7dd85fa9cb3a2892cba21b8302_283909_480x0_resize_q90_lanczos.jpg 480w, /blog/2020/01/ricardo-gomez-angel-87vUJY3ntyI-unsplash_hu98532f7dd85fa9cb3a2892cba21b8302_283909_768x0_resize_q90_lanczos.jpg 768w, /blog/2020/01/ricardo-gomez-angel-87vUJY3ntyI-unsplash_hu98532f7dd85fa9cb3a2892cba21b8302_283909_1024x0_resize_q90_lanczos.jpg 1024w" src=/blog/2020/01/ricardo-gomez-angel-87vUJY3ntyI-unsplash.jpg alt=&nbsp;></figure></p><p>A recent client request showed how useful perf is in exposing the areas of MySQL that are otherwise well tuned, but can still be in need of coding improvements that increase throughput. The client had a <a href=https://sourceforge.net/projects/tpccruner/ target=_blank rel="noopener noreferrer">TPCCRunner</a> (variant) workload that they wanted to run on a <a href=https://www.ibm.com/it-infrastructure/power/power9 target=_blank rel="noopener noreferrer">Power 9</a> CPU, in <a href=https://dev.mysql.com/doc/refman/5.7/en/innodb-transaction-isolation-levels.html#isolevel_read-committed target=_blank rel="noopener noreferrer">READ-COMMITTED</a> mode, and they received less performance than they hoped. Being a 2 socket, 20 cpus/socket 4 threads per core, and 256G RAM total it has enough resources.</p><p>With such abundance of resources, the perf profile exposed code bottlenecks not normally seen.</p><p>The principles driving MySQL development for a considerable time have been to a) maintain correctness, and b) deliver performance, usually meaning the CPU should be the bottleneck. The whole reason for large innodb buffer pools, innodb MVCC / LSN, group commit, table caches, thread caches, indexes, query planner etc, is to ensure that all hot data is in memory, ready to be processed optimally in the most efficient way by the CPU.</p><p>Based on this principle, without a requirement to sync to persistent storage for durability, a SQL read mostly load should be able to add scale linearly up to the CPU capacity. Ideally after the CPU capacity has been reached the throughput should stay at the capacity limit and not degrade. Practical overheads of thread measurement mean this is never perfectly achieved. However, it is the goal.</p><h2 id=steps-to-using-perf>Steps to using perf</h2><p>To install and use perf, use the following steps:</p><h4 id=1-install-perf>1. Install perf</h4><p>This is a standard package and is closely tied to the Linux kernel version. The package name varies per distro:</p><ul><li>Ubuntu: <a href=https://packages.ubuntu.com/bionic/linux-tools-common target=_blank rel="noopener noreferrer">linux-tools-common</a></li><li>Debian: <a href=https://packages.debian.org/buster/linux-base target=_blank rel="noopener noreferrer">linux-base</a></li><li>RHEL / Centos / Fedora: perf</li></ul><p>Distributions normally set the <a href=http://man7.org/linux/man-pages/man8/sysctl.8.html target=_blank rel="noopener noreferrer">sysctl</a> <a href=https://www.kernel.org/doc/html/latest/admin-guide/sysctl/kernel.html#perf-event-paranoid target=_blank rel="noopener noreferrer"><em>kernel.perf_event_paranoid</em></a> to a level which is hard to use (or <a href=https://www.kernel.org/doc/html/latest/admin-guide/perf-security.html target=_blank rel="noopener noreferrer">exploit</a>) and this may need to be adjusted to obtain our recording. Large perf recordings due to hardware threads can require file descriptors and memory, and their limits may need to be increased with care (see <a href=https://www.kernel.org/doc/html/latest/admin-guide/perf-security.html#perf-events-perf-resource-control target=_blank rel="noopener noreferrer">kernel manual</a>).</p><h4 id=2-install-debug-symbols-aka-debug-info-for-mysql>2. Install debug symbols (a.k.a. debug info) for MySQL</h4><p>Debug symbols mapping memory addresses to real server code can assist greatly in understanding the recorded results. The debug info needs to map to the exact build of MySQL (both version number and its origin).</p><p>Distros provide debug information in separate package repositories (distribution instructions: <a href=https://wiki.ubuntu.com/Debug%20Symbol%20Packages target=_blank rel="noopener noreferrer">Ubuntu</a>, <a href=https://wiki.debian.org/AutomaticDebugPackages target=_blank rel="noopener noreferrer">Debian</a>, <a href=https://access.redhat.com/solutions/9907 target=_blank rel="noopener noreferrer">RHEL</a>, <a href=https://fedoraproject.org/wiki/StackTraces#What_are_debuginfo_rpms.2C_and_how_do_I_get_them.3F target=_blank rel="noopener noreferrer">Fedora</a>) and MySQL, <a href=https://mariadb.com/kb/en/library/how-to-produce-a-full-stack-trace-for-mysqld/#installing-debug-info-packages-on-linux target=_blank rel="noopener noreferrer">MariaDB</a> and Percona provide debug info packages in their repositories without additional configuration.</p><p>If compiling from source, the default cmake option -DCMAKE_BUILD_TYPE=RelWithDebugInfo¬† has debug info as the name suggests.</p><h4 id=3-ensure-that-your-table-structures-and-queries-are-sane>3. Ensure that your table structures and queries are sane.</h4><p>MySQL works well when the database table structures, indexes, and queries are in a <code>natural</code> simple form. Asking MySQL developers to make poor table structures/queries to achieve greater performance will attract a low priority as making these changes can add to the overhead of simple queries.</p><h4 id=4-ensure-that-you-have-tuned-the-database-for-the-workload>4. Ensure that you have tuned the database for the workload.</h4><p>MySQL has a lot of system variables, and using the performance schema and status variables assists in creating an optimally tuned MySQL instance before beginning perf measurements.</p><h4 id=5-ensure-that-the-active-data-is-off-disk>5. Ensure that the active data is off disk</h4><p>To ensure you measurement is at its maximum, having the hot part of the data loaded into memory enables perf to focus on recording CPU related areas under stress, not just waiting to load from disk.</p><p>For example, the TPCCRunner example described earlier took about an hour before it reached a point where it achieved its maximum transaction throughput. TPCRunner displays this, but generally watch for a leveling out of the queries per second over several minutes.</p><p>When starting/stopping mysqld for testing, <a href=https://dev.mysql.com/doc/refman/5.7/en/innodb-parameters.html#sysvar_innodb_buffer_pool_dump_at_shutdown target=_blank rel="noopener noreferrer">innodb_buffer_pool_dump_at_shutdown</a>=1 / innodb_buffer_pool_dump_at_start=1 / innodb_buffer_pool_dump_pct=100 will help restore the innodb buffer pool significantly quicker.</p><h4 id=6-know-what-workload-is-being-measured>6. Know what workload is being measured</h4><p>A batch job may not have the same throughput requirements. It also may impact the concurrent workload that you are perf recording by creating longer history length, innodb buffer pool pressure etc.</p><p>The application that generates the workload should be on a different server, different VM or in some way constrained in CPU to avoid resource contention with mysqld. Check the client side to ensure that it isn&rsquo;t overloaded (CPU, network) as this could be indirectly constraining the server side workload.</p><h2 id=measuring>Measuring</h2><p>With a hot workload running let&rsquo;s start some measurement.</p><p>Perf uses hardware (PMU) to assist its recording work, but there are limits to hardware support so there&rsquo;s a point where it will affect your workload, so start slow. Perf works by looking at a frequency distribution of where the mysqld process is spending its time. To examine a function that is taking 0.1% of the time means that 1000 samples will likely show it once. As such a few thousand samples is sufficient. The number of samples is the multiplication of <a href=http://man7.org/linux/man-pages/man1/perf-record.1.html target=_blank rel="noopener noreferrer">perf record&rsquo;s</a> <em>-F / &ndash;freq</em> ‚Äì which may by default be several thousand / second ‚Äì the recording duration, and the number of CPUs.</p><p>If your SQL queries are all running in much less than a second and occurring frequently, then a high frequency recording for a short duration is sufficient. If some query occurs less often, with a high CPU usage spike, a helper program <a href=https://github.com/Netflix/flamescope target=_blank rel="noopener noreferrer">FlameScope</a> will be able to narrow down a perf recording to a usable sample interval.</p><p>Analysis involves looking through a number of sets of data. Below I show a pattern of using _name¬†_as a shell variable, and a large one line command to conduct a number of recordings in sequence. In my case, I cycled through _RC¬†_ (read-committed) vs _RR¬†_(repeatable read), different compile options <em>-O0</em> , kernel versions, final stages of _warmup¬†_(compared to test run) and even local changes to mysqld (thread_local_ut_rnd_ulint_counter ). Keeping track of these alongside the same measurement of the test run output helps to correlate results more easily.</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>name=5.7.28-thread_local_ut_rnd_ulint_counterO0-RC_warmup2 ; 
pid=$(pidof mysqld); 
perf record -F 10 -o mysql-${name}.perf  -p $pid ¬†-- sleep 20; 
perf record -g -F 10 -o mysql-${name}.g.perf  -p $pid ¬†-- sleep 5; 
perf stat -B -e cache-references,cache-misses,cycles,instructions,branches,faults,migrations -p $pid sleep 20 
2&gt;&amp;1  | tee perf-stats-${name}.txt

</code></pre></div><p>With the above command, the recording is constrained the recording to mysqld (<em>-p $pid</em>), at <em>-F 10</em> samples/per second for (<em>sleep</em>) <em>20</em> seconds. A longer recording without the stack trace (-g) is taken as reference point to see if the shorter recording with <em>-g</em> stack trace is a fair sample. 10 hz x 20 seconds may not seem like many samples, however this occurred on each of the 160 threads. A record with <em>-g</em> is needed as a perf profile that shows all time in the kernel or pthread mutex (lock) code, but it doesn&rsquo;t mean much without knowing which lock it is and where it was accessed from.</p><p>Perf record with <em>-g</em> call-graph (also known as stack chain or backtrace) adds to the size of the recording and the overhead of measurements. To ensure that there isn&rsquo;t too much perf data (resulting in workload stalls), get the right frequency and duration before enabling <em>-g</em>.</p><p>Perf stats were measured to identify (cpu) cache efficiency, instructions/cycle efficiency, instructions throughput (watch out for frequency scaling), faults (connecting real memory to the virtual address - should be low after warmup), and migrations between numa nodes.</p><p>During measurement look at <em>htop</em>/<em>top</em> to ensure that the CPUs are indeed loaded. Also check the client side isn&rsquo;t flooded with connection errors that could impact the validity of the recorded results.</p><h2 id=analysis>Analysis</h2><h3 id=viewing-a-perf-recording>Viewing a perf recording</h3><p><a href=http://man7.org/linux/man-pages/man1/perf-report.1.html target=_blank rel="noopener noreferrer">perf report</a> is used to textually view a perf recording. It is during the report stage that the debug info is read, since the linux kernel image resolves symbols. Run the report under <code>nice -n 19 perf report</code> to ensure it has the lowest CPU priority if you are at all concerned about production impacts. It&rsquo;s quite possible to do this on a different server provided the same kernel and MySQL packages are installed. <code>perf report --input mysql-5.7.28-event_run2_warmup_run1.perf --stdio</code></p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback># Total Lost Samples: 0
#
# Samples: 91K of event &#39;cycles:ppp&#39;
# Event count (approx.): 1261395960159641
#
# Overhead  Command  Shared Object        Symbol                                                                         
# ........  .......  ...................  ...............................................................................
#
     5.84%  mysqld   mysqld               [.] rec_get_offsets_func
     3.62%  mysqld   mysqld               [.] MYSQLparse
     2.70%  mysqld   mysqld               [.] page_cur_search_with_match
     2.70%  mysqld   mysqld               [.] buf_page_get_gen
     2.22%  mysqld   mysqld               [.] cmp_dtuple_rec_with_match_low
     1.93%  mysqld   mysqld               [.] buf_page_hash_get_low
     1.49%  mysqld   mysqld               [.] btr_cur_search_to_nth_level
     1.35%  mysqld   [kernel.kallsyms]    [k] do_syscall_64
     1.14%  mysqld   mysqld               [.] row_search_mvcc
     0.93%  mysqld   mysqld               [.] alloc_root
     0.92%  mysqld   mysqld               [.] lex_one_token
     0.67%  mysqld   libc-2.27.so         [.] malloc
     0.64%  mysqld   libc-2.27.so         [.] _int_malloc
     0.61%  mysqld   libpthread-2.27.so   [.] __pthread_getspecific
     0.59%  mysqld   mysqld               [.] pfs_rw_lock_s_lock_func
     0.59%  mysqld   mysqld               [.] dispatch_command
     0.50%  mysqld   mysqld               [.] check_stack_overrun
     0.50%  mysqld   [tg3]                [k] tg3_poll_work
</code></pre></div><p>This shows a %CPU time measured when the CPU instruction pointer was at a particular time, grouped by the function name. To find out why malloc or the kernel do_syscall_64 appears so often the stack recording is needed.</p><h3 id=viewing-a-perf-recording-with-a-stack>Viewing a perf recording with a stack</h3><p>When the <em>perf record</em> used <em>-g</em>, then <em>-g</em> can be used in perf report to show the breakdown. By default it groups the functions, including the functions it calls, as below.
<code>perf report -i mysql-5.7.28-event_run2_warmup_run1.g.perf</code></p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>Samples: 85K of event &#39;cycles:ppp&#39;, Event count (approx.): 261413311777846
  Children      Self  Command  Shared Object        Symbol
+   80.08%     0.00%  mysqld   libpthread-2.27.so   [.] start_thread
+   80.08%     0.00%  mysqld   mysqld               [.] pfs_spawn_thread
+   80.05%     0.07%  mysqld   mysqld               [.] handle_connection
+   79.75%     0.14%  mysqld   mysqld               [.] do_command
+   77.98%     0.70%  mysqld   mysqld               [.] dispatch_command
+   75.32%     0.18%  mysqld   mysqld               [.] mysql_parse
+   62.63%     0.38%  mysqld   mysqld               [.] mysql_execute_command
+   58.65%     0.13%  mysqld   mysqld               [.] execute_sqlcom_select
+   55.63%     0.05%  mysqld   mysqld               [.] handle_query
+   25.31%     0.41%  mysqld   mysqld               [.] st_select_lex::optimize
+   24.67%     0.12%  mysqld   mysqld               [.] JOIN::exec
+   24.45%     0.59%  mysqld   mysqld               [.] JOIN::optimize
+   22.62%     0.29%  mysqld   mysqld               [.] sub_select
+   20.15%     1.56%  mysqld   mysqld               [.] btr_cur_search_to_nth_level
</code></pre></div><p>In MySQL, as expected, most significant CPU load is in the threads. Most of the time this is a user connection, under the <em>handle_connection</em> function, which parses and executes the SQL. In different situations you might see innodb background threads, or replication threads: understanding which thread is causing the load is important at a top level. Then, to continue analysis, use the perf report <em>&ndash;no-children</em> option. This will show approximately the same as the non_-g_ recording, however it will provide the mechanism of being able to hit Enter on a function to show all the call stacks that go to that particular function.
<code>perf report -g --no-children --input mysql-5.7.28-event_run2_warmup_run1.g.perf</code></p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>  Overhead  Command  Shared Object        Symbol                                                                                                ‚óÜ
-    6.24%  mysqld   mysqld               [.] rec_get_offsets_func                                                                              ‚ñí
     start_thread                                                                                                                               ‚ñí
     pfs_spawn_thread                                                                                                                           ‚ñí
     handle_connection                                                                                                                          ‚ñí
     do_command                                                                                                                                 ‚ñí
     dispatch_command                                                                                                                           ‚ñí
     mysql_parse                                                                                                                                ‚ñí
     mysql_execute_command                                                                                                                      ‚ñí
     execute_sqlcom_select                                                                                                                      ‚ñí
   - handle_query                                                                                                                               ‚ñí
      - 4.57% JOIN::exec                                                                                                                        ‚ñí
         - sub_select                                                                                                                           ‚ñí
            + 3.77% evaluate_join_record                                                                                                        ‚ñí
            + 0.60% join_read_always_key                                                                                                        ‚ñí
      + 1.67% st_select_lex::optimize
</code></pre></div><p>This shows a common call stack into <em>handle_query</em>, where the <em>JOIN::exec</em> and <em>st_select_lex::optimize</em> is the diverging point. If the <em>evaluate_join_record</em> and other sub-functions were to be expanded, the bottom level of the call graph would show <em>rec_get_offsets_func.</em></p><h3 id=disassembly-annotation>Disassembly (annotation)</h3><p>In the ncurses interfaces. Selecting &lsquo;a&rsquo; (annotate) on a particular function calls out to the <a href=https://linux.die.net/man/1/objdump target=_blank rel="noopener noreferrer">objdump</a> (binutils) disassembler to show where in this function the highest frequency occurred and maps this to a commented C++ code above it.</p><p>As compilers have significant understanding of the architecture, and given that the C/C++ language provides significant freedom in generating code, it&rsquo;s sometimes quite difficult to parse from assembly back to the C/C++ source. In complex operations, C++ variables don&rsquo;t have an easy translation to CPU registers. Inlined functions are also particularly hard as each inlining can further be optimized to a unique assembly depending on its location. To understand the assembly, I recommend focusing on the loads, stores, maths/conditions with constants and branches to see which register maps to which part of the MySQL server code in the context of the surrounding code.</p><p>E.g annotation on <em>rec_get_offsets_func</em>:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>       ‚îÇ     dict_table_is_comp():
       ‚îÇ
       ‚îÇ     #if DICT_TF_COMPACT != 1
       ‚îÇ     #error &#34;DICT_TF_COMPACT must be 1&#34;
       ‚îÇ     #endif
       ‚îÇ
       ‚îÇ             return(table-&gt;flags &amp; DICT_TF_COMPACT);
  0.44 ‚îÇ       mov    0x20(%rsi),%rsi
 39.30 ‚îÇ       movzbl -0x3(%rdi),%eax
       ‚îÇ     _Z20rec_get_offsets_funcPKhPK12dict_index_tPmmPP16mem_block_info_t():
       ‚îÇ
       ‚îÇ             ut_ad(rec);
       ‚îÇ             ut_ad(index);
       ‚îÇ             ut_ad(heap);
       ‚îÇ
       ‚îÇ             if (dict_table_is_comp(index-&gt;table)) {
  0.44 ‚îÇ       testb  $0x1,0x34(%rsi)
  0.15 ‚îÇ     ‚Üì je     e611d8 &lt;rec_get_offsets_func(unsigned char const*, dict_index_t const*, 128
       ‚îÇ                     switch (UNIV_EXPECT(rec_get_status(rec),
</code></pre></div><p>Here we see that <em>dict_table_is_comp</em> is an expanded inline function at the top of <em>rec_get_offsets</em>, the <em>movzlb .. %eax.</em>¬†The dominate CPU use in the function however isn&rsquo;t part of this. The <em>testb 0x1 (DICT_TF_COMPACT) &mldr; %rsi</em> is the testing of the flag with <em>je</em> afterwards to return from the function.</p><h2 id=example---mutex-contention>Example - mutex contention</h2><p>Compared to the performance profile on x86 above under &lsquo;Viewing a perf recording&rsquo;, this is what the performance profile looked like on POWER. perf report &ndash;input mysql-5.7.28-read_mostly_EVENT_RC-run2.perf &ndash;stdio</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback># Total Lost Samples: 0
#
# Samples: 414K of event &#39;cycles:ppp&#39;
# Event count (approx.): 3884039315643070
#
# Overhead  Command  Shared Object        Symbol                                                                         
# ........  .......  ...................  ...............................................................................
    13.05%  mysqld   mysqld               [.] MVCC::view_open
    10.99%  mysqld   mysqld               [.] PolicyMutex&lt;TTASEventMutex&lt;GenericPolicy&gt; &gt;::enter
     4.11%  mysqld   mysqld               [.] rec_get_offsets_func
     3.78%  mysqld   mysqld               [.] buf_page_get_gen
     2.34%  mysqld   mysqld               [.] MYSQLparse
     2.27%  mysqld   mysqld               [.] cmp_dtuple_rec_with_match_low
     2.15%  mysqld   mysqld               [.] btr_cur_search_to_nth_level
     2.05%  mysqld   mysqld               [.] page_cur_search_with_match
     1.99%  mysqld   mysqld               [.] ut_delay
     1.83%  mysqld   mysqld               [.] mtr_t::release_block_at_savepoint
     1.35%  mysqld   mysqld               [.] rw_lock_s_lock_func
     0.96%  mysqld   mysqld               [.] buf_page_hash_get_low
     0.88%  mysqld   mysqld               [.] row_search_mvcc
     0.84%  mysqld   mysqld               [.] lex_one_token
     0.80%  mysqld   mysqld               [.] pfs_rw_lock_s_unlock_func
     0.80%  mysqld   mysqld               [.] mtr_t::commit
     0.62%  mysqld   mysqld               [.] pfs_rw_lock_s_lock_func
     0.59%  mysqld   [kernel.kallsyms]    [k] power_pmu_enable
     0.59%  mysqld   [kernel.kallsyms]    [k] _raw_spin_lock
     0.55%  mysqld   libpthread-2.28.so   [.] __pthread_mutex_lock
     0.54%  mysqld   mysqld               [.] alloc_root
     0.43%  mysqld   mysqld               [.] PolicyMutex&lt;TTASEventMutex&lt;GenericPolicy&gt; &gt;::exit
</code></pre></div><p>What stands out clearly is the top two entries that didn&rsquo;t appear on x86. Looking closer at <em>MVCC::view_open</em>:
<code>perf report -g --no-children --input mysql-5.7.28-read_mostly_EVENT_RC-run2.g.perf</code></p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>-   13.47%  mysqld   mysqld               [.] MVCC::view_open                                                                                                                                                          ‚ñí
     __clone                                                                                                                                                                                                           ‚ñí
     0x8b10                                                                                                                                                                                                            ‚ñí
     pfs_spawn_thread                                                                                                                                                                                                  ‚ñí
     handle_connection                                                                                                                                                                                                 ‚ñí
     do_command                                                                                                                                                                                                        ‚ñí
     dispatch_command                                                                                                                                                                                                  ‚ñí
     mysql_parse                                                                                                                                                                                                       ‚ñí
     mysql_execute_command                                                                                                                                                                                             ‚ñí
     execute_sqlcom_select                                                                                                                                                                                             ‚ñí
   - handle_query                                                                                                                                                                                                      ‚ñí
      - 11.22% JOIN::exec                                                                                                                                                                                              ‚ñí
         - sub_select                                                                                                                                                                                                  ‚ñí
            - 10.99% join_read_always_key                                                                                                                                                                              ‚ñí
                 handler::ha_index_read_map                                                                                                                                                                            ‚ñí
                 ha_innobase::index_read                                                                                                                                                                               ‚ñí
               - row_search_mvcc                                                                                                                                                                                       ‚ñí
                  - 10.99% trx_assign_read_view                                                                                                                                                                        ‚ñí
                       MVCC::view_open
</code></pre></div><p>Annotation of MVCC::view_open</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>       ‚îÇ     _ZNK14TTASEventMutexI13GenericPolicyE7is_freeEjjRj():                                                                                                                                                     ‚ñí
       ‚îÇ             bool is_free(                                                                                                                                                                                     ‚ñí
  0.02 ‚îÇa08: ‚Üì bne    cr4,10db7a30 &lt;MVCC::view_open(ReadView*&amp;, a90                                                                                                                                                    ‚ñí
       ‚îÇ     ‚Üì b      10db7ad0 &lt;MVCC::view_open(ReadView*&amp;, trx_t*)+0xb30&gt;                                                                                                                                             ‚ñí
       ‚îÇ     ut_rnd_gen_ulint():                                                                                                                                                                                       ‚ñí
       ‚îÇ             ut_rnd_ulint_counter = UT_RND1 * ut_rnd_ulint_counter + UT_RND2;                                                                                                                                  ‚ñí
       ‚îÇa10:   addis  r7,r2,2                                                                                                                                                                                          ‚ñí
  0.02 ‚îÇ       addi   r7,r7,26904                                                                                                                                                                                      ‚ñí
 81.15 ‚îÇ       ld     r8,0(r7)                                                                                                                                                                                         ‚ñí
  0.02 ‚îÇ       mulld  r8,r27,r8                                                                                                                                                                                        ‚ñí
  0.02 ‚îÇ       addis  r8,r8,1828                                                                                                                                                                                       ‚ñí
  0.02 ‚îÇ       addi   r8,r8,-14435                                                                                                                                                                                     ‚ñí
       ‚îÇ     ut_rnd_gen_next_ulint():                                                                                                                                                                                  ‚ñí
       ‚îÇ             rnd = UT_RND2 * rnd + UT_SUM_RND3;                                                                                                                                                                ‚ñí
  0.02 ‚îÇ       mulld  r9,r8,r19                                                                                                                                                                                        ‚ñí
       ‚îÇ     ut_rnd_gen_ulint():                                                                                                                                                                                       ‚ñí
       ‚îÇ             ut_rnd_ulint_counter = UT_RND1 * ut_rnd_ulint_counter + UT_RND2;                                                                                                                                  ‚ñí
  0.04 ‚îÇ       std    r8,0(r7)
</code></pre></div><p>Due to the inline of code, within <a href=https://github.com/mysql/mysql-server/blob/mysql-5.7.28/storage/innobase/read/read0read.cc#L554..L611 target=_blank rel="noopener noreferrer">MVCC::view_open</a> one of the mutexs got expanded out and the random number is used to spinlock wait for the lock again. <a href=https://github.com/mysql/mysql-server/blob/mysql-5.7.28/storage/innobase/include/ib0mutex.h#L707..L717 target=_blank rel="noopener noreferrer">PolicyMutex&lt;TTASEventMutex<genericpolicy> >::enter</a> expanded to exactly the same code.</p><p>We see here that the load (<em>ld</em>) into <em>r8</em>, is the slowest part of this. In mysql-5.7.28, <a href=https://github.com/mysql/mysql-server/blob/mysql-5.7.28/storage/innobase/ut/ut0rnd.cc#L48 target=_blank rel="noopener noreferrer">ut_rnd_ulint_counter</a> is an ordinary global variable, meaning its shared between threads. The simple line of code <em>ut_rnd_ulint_counter = UT_RND1 * ut_rnd_ulint_counter + UT_RND2</em>,¬† shows the result stored back in the same variable. To understand why this didn&rsquo;t scale, we need to understand cache lines.</p><p>note: <em>MVCC::view_open</em> did show up in the x86 profile, at 0.23% and had the lock release as the highest cpu point. For x86 <em>PolicyMutex&lt;TTASEventMutex<genericpolicy> >::enter</em> was at 0.32%.</p><h3 id=cache-lines>Cache Lines</h3><p>All modern CPUs that are likely to support MySQL will have some from of <a href=https://en.wikipedia.org/wiki/Cache_hierarchy target=_blank rel="noopener noreferrer">cache hierarchy</a>. The principles are that a largely accessed memory location, like <em>ut_rnd_ulint_counter</em>, can be copied into cache and at some point the CPU will push it back to memory. To ensure behavior is consistent, cache lines represent a MMU (memory management unit) concept of a memory allocation to a particular CPU. Cache lines can be read only, or exclusive, and a protocol between CPU cores exists to ensure that exclusive access is to one CPU only. When one CPU modifies a memory location it gains an exclusive cache line, and the cached value in other CPU caches are flushed. At which cache level this flushing occurs at, and to what extent are caches shared between CPUs, is quite architecture specific. However, citing rough <a href=http://brenocon.com/dean_perf.html target=_blank rel="noopener noreferrer">metrics</a>, cache access is orders of magnitude faster than RAM.</p><p>In the perf recording above, storing back of <em>ut_rnd_ulint_counter</em> clears the cache for the other CPUs, and this is why the load instruction is slow. MySQL did have this fixed in <a href=https://github.com/mysql/mysql-server/commit/dedc8b3d567fbb92ce912f1559fe6a08b2857045 target=_blank rel="noopener noreferrer">5.7.14</a> but reverted this fix in <a href=https://github.com/mysql/mysql-server/commit/dedc8b3d567fbb92ce912f1559fe6a08b2857045 target=_blank rel="noopener noreferrer">5.7.20</a> (assuming some performance degradation in thread local storage). In MySQL <a href=https://github.com/mysql/mysql-server/commit/ea4913b403db72f26565520f68686b385872e7d2#diff-5f582f65ca6be1efafb5e278e4bffc44R35 target=_blank rel="noopener noreferrer">8.0+</a>, <em>ut_rnd_ulint_counter</em> is a C++11 <a href=http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2008/n2659.htm target=_blank rel="noopener noreferrer">thread_local</a> variable which has a faster implementation. <a href=https://github.com/MariaDB/server/commit/ce04790 target=_blank rel="noopener noreferrer">MariaDB-10.3.5</a> avoided this by removing the random delay in InnoDB mutexes. Thread local variables reduce contention because each thread has its independent memory location. Because this is only a random number seed, there&rsquo;s no need for synchronization of results.</p><h3 id=cache-collisions>Cache collisions</h3><p>The impacts of <em>ut_rnd_ulint_counter</em> however aren&rsquo;t limited to itself. Cache lines reserve blocks of memory according to the cache line size of the architecture (x86 - 64 bytes, arm64 and POWER - 128 bytes, s390 - 256 bytes). High in the CPU profile is the <em>btr_cur_search_to_nth_level</em> function. This is part of innodb&rsquo;s scanning of an index and it would be easy to discount its high CPU usage. Looking at the disassembly however shows:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>  0.01 ‚îÇ        ld     r8,3464(r31)
       ‚îÇ                      cursor-&gt;low_match = low_match;
  0.05 ‚îÇ        std    r10,96(r25)
       ‚îÇ                      cursor-&gt;up_bytes = up_bytes;
  0.00 ‚îÇ        ld     r10,3456(r31)
       ‚îÇ                      if (btr_search_enabled &amp;&amp; !index-&gt;disable_ahi) {
 24.08 ‚îÇ        lbz    r9,0(r9)
       ‚îÇ                      cursor-&gt;low_bytes = low_bytes;
  0.01 ‚îÇ        std    r7,104(r25)
       ‚îÇ                      cursor-&gt;up_match = up_match;
  0.00 ‚îÇ        std    r8,80(r25)
       ‚îÇ                      cursor-&gt;up_bytes = up_bytes;
  0.01 ‚îÇ        std    r10,88(r25)
       ‚îÇ                      if (UNIV_LIKELY(btr_search_enabled) &amp;&amp; !index-&gt;disable_ahi) {
  0.00 ‚îÇ        cmpwi  cr7,r9,0
  0.00 ‚îÇ        ld     r9,48(r29)
  0.01 ‚îÇ      ‚Üì beq    cr7,10eb88a8 &lt;btr_cur_search_to_nth_level(dict_index_t*, 2348
</code></pre></div><p>The <em>lbz</em> is a load byte instruction referring to <em>btr_search_enabled</em>. <em>btr_search_enabled</em> and is the MySQL server variable associated with the SQL global <a href=https://dev.mysql.com/doc/refman/5.7/en/innodb-parameters.html#sysvar_innodb_adaptive_hash_index target=_blank rel="noopener noreferrer">innodb_adaptive_hash_index</a> . As a global system variable, this isn&rsquo;t changed frequently, probably only once at startup. As such it should be able to rest comfortably in the cache of all CPUs in a read only cache line.</p><p>To find out why the relative address is examined in the mysql executable:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>$ readelf -a bin/mysqld | grep btr_search_enabled
  8522: 0000000011aa1b40     1 OBJECT  GLOBAL DEFAULT   24 btr_search_enabled
 17719: 0000000011aa1b40     1 OBJECT  GLOBAL DEFAULT   24 btr_search_enabled
</code></pre></div><p>Taking the last two characters off the hexadecimal address <em>0000000011aa1b40</em> and the other variables in the same 256 (0x100) byte address range can be examined.</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>$ readelf -a bin/mysqld | grep 0000000011aa1b
  1312: 0000000011aa1be0   296 OBJECT  GLOBAL DEFAULT   24 fts_default_stopword
  8522: 0000000011aa1b40     1 OBJECT  GLOBAL DEFAULT   24 btr_search_enabled
  9580: 0000000011aa1b98    16 OBJECT  GLOBAL DEFAULT   24 fil_addr_null
 11434: 0000000011aa1b60     8 OBJECT  GLOBAL DEFAULT   24 zip_failure_threshold_pct
 12665: 0000000011aa1b70    40 OBJECT  GLOBAL DEFAULT   24 dot_ext
 13042: 0000000011aa1b30     8 OBJECT  GLOBAL DEFAULT   24 ut_rnd_ulint_counter
 13810: 0000000011aa1b48     8 OBJECT  GLOBAL DEFAULT   24 srv_checksum_algorithm
 18831: 0000000011aa1bb0    48 OBJECT  GLOBAL DEFAULT   24 fts_common_tables
 27713: 0000000011aa1b38     8 OBJECT  GLOBAL DEFAULT   24 btr_ahi_parts
 33183: 0000000011aa1b50     8 OBJECT  GLOBAL DEFAULT   24 zip_pad_max
  2386: 0000000011aa1b58     7 OBJECT  LOCAL  DEFAULT   24 _ZL9dict_ibfk
  5961: 0000000011aa1b68     8 OBJECT  LOCAL  DEFAULT   24 _ZL8eval_rnd
 10509: 0000000011aa1be0   296 OBJECT  GLOBAL DEFAULT   24 fts_default_stopword
 17719: 0000000011aa1b40     1 OBJECT  GLOBAL DEFAULT   24 btr_search_enabled
 18777: 0000000011aa1b98    16 OBJECT  GLOBAL DEFAULT   24 fil_addr_null
 20631: 0000000011aa1b60     8 OBJECT  GLOBAL DEFAULT   24 zip_failure_threshold_pct
 21862: 0000000011aa1b70    40 OBJECT  GLOBAL DEFAULT   24 dot_ext
 22239: 0000000011aa1b30     8 OBJECT  GLOBAL DEFAULT   24 ut_rnd_ulint_counter
 23007: 0000000011aa1b48     8 OBJECT  GLOBAL DEFAULT   24 srv_checksum_algorithm
 28028: 0000000011aa1bb0    48 OBJECT  GLOBAL DEFAULT   24 fts_common_tables
 36910: 0000000011aa1b38     8 OBJECT  GLOBAL DEFAULT   24 btr_ahi_parts
 42380: 0000000011aa1b50     8 OBJECT  GLOBAL DEFAULT   24 zip_pad_max
</code></pre></div><p>The <em>ut_rnd_ulint_counter</em> is stored 16 bytes away from the <em>btr_search_enabled</em>. Because of this, every invalidation of <em>ut_rnd_ulint_counter</em> cache line results in a cache invalidation of <em>btr_search_enabled</em> on POWER, and every other variable in the <em>0000000011aa1b00 to 0000000011aa1b40</em> address range for x86_64 (or to <em>0000000011aa1b80</em> for POWER and ARM64, or to <em>0000000011aa1c00</em> for s390). There are no rules governing the layout of these variables so it was only luck that caused x86_64 to not be affected here.</p><p>While the contended management of <em>ut_rnd_ulint_counter</em> remains an unsolved problem on MySQL-5.7, putting all the global variables into the same memory block as a way to keep them out of the same cache as other potentially frequently changed variables is a way to prevent unintended contention. Global variables are an ideal candidate for this as they are changed infrequently and are usually hot in code paths. By pulling all the global variables in the same location, this maximized the cache by using less cache lines that remain in a read only mode.</p><p>To achieve this co-location, MySQL uses the Linux kernel mechanism of using <a href=https://gcc.gnu.org/onlinedocs/gcc/Common-Variable-Attributes.html#index-section-variable-attribute target=_blank rel="noopener noreferrer">section attributes on variables</a> and a linker script to bind their location. This was is described in MySQL <a href="https://bugs.mysql.com/bug.php?id=97777" target=_blank rel="noopener noreferrer">bug 97777</a> and the MariaDB task <a href=https://jira.mariadb.org/browse/MDEV-21145 target=_blank rel="noopener noreferrer">MDEV-21145</a>. The segmenting of the system global variables using this mechanism resulted in a 5.29% increase in the transactions per minute of the TPCCRunner benchmark (using MUTEXTYPE=sys).</p><h2 id=mutex-implementations>Mutex Implementations</h2><p>Having discovered what I thought to be a smoking gun with the <em>ut_rnd_ulint_counter</em> contention being the source of throughput problems for the benchmark, the <em>thread_local</em> implementation of MySQL-8.0 was back-ported to MySQL-5.7.28. Disappointingly it was discovered that the throughput was approximately the same. From a perf profile perspective, the CPU usage was no longer in the inlined <em>ut_rnd_gen_ulint</em> function, it was in the <a href=https://github.com/mysql/mysql-server/blob/mysql-5.7.28/storage/innobase/sync/sync0arr.cc#L451..L488 target=_blank rel="noopener noreferrer">sync_array_wait_event</a> and <a href=https://github.com/mysql/mysql-server/blob/mysql-5.7.28/storage/innobase/sync/sync0arr.cc#L333..L400 target=_blank rel="noopener noreferrer">sync_array_reserve_cell</a> functions.</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>Samples: 394K of event &#39;cycles:ppp&#39;, Event count (approx.): 2348024370370315
¬† Overhead  Command  Shared Object               Symbol                                                                                                                               ‚óÜ
-   45.48%  mysqld   [kernel.vmlinux]            [k] _raw_spin_lock                                                                                                                   ‚ñí
     __clone                                                                                                                                                                          ‚ñí
   - 0x8b10                                                                                                                                                                           ‚ñí
      - 45.48% pfs_spawn_thread                                                                                                                                                       ‚ñí
           handle_connection                                                                                                                                                          ‚ñí
         - do_command                                                                                                                                                                 ‚ñí
            - 45.44% dispatch_command                                                                                                                                                 ‚ñí
               - 45.38% mysql_parse                                                                                                                                                   ‚ñí
                  - 45.38% mysql_execute_command                                                                                                                                      ‚ñí
                     - 44.75% execute_sqlcom_select                                                                                                                                   ‚ñí
                        - handle_query                                                                                                                                                ‚ñí
                           - 38.28% JOIN::exec                                                                                                                                        ‚ñí
                              - 25.34% sub_select                                                                                                                                     ‚ñí
                                 - 24.85% join_read_always_key                                                                                                                        ‚ñí
                                      handler::ha_index_read_map                                                                                                                      ‚ñí
                                    - ha_innobase::index_read                                                                                                                         ‚ñí
                                       - 24.85% row_search_mvcc                                                                                                                       ‚ñí
                                          - 24.85% trx_assign_read_view                                                                                                               ‚ñí
                                             - MVCC::view_open                                                                                                                        ‚ñí
                                                - 12.00% sync_array_wait_event                                                                                                        ‚ñí
                                                   - 5.44% os_event::wait_low                                                                                                         ‚ñí
                                                      - 2.21% os_event::wait_low                                                                                                      ‚ñí
                                                           __pthread_mutex_unlock                                                                                                     ‚ñí
                                                           system_call                                                                                                                ‚ñí
                                                           sys_futex                                                                                                                  ‚ñí
                                                         + do_futex                                                                                                                   ‚ñí
                                                      + 2.04% __pthread_mutex_lock                                                                                                    ‚ñí
                                                      + 0.94% pthread_cond_wait                                                                                                       ‚ñí
                                                   + 2.34% __pthread_mutex_lock                                                                                                       ‚ñí
                                                   + 2.28% sync_array_free_cell                                                                                                       ‚ñí
                                                   + 1.60% sync_array_wait_event                                                                                                      ‚ñí
                                                + 10.69% sync_array_reserve_cell                                                                                                      ‚ñí
                                                + 1.32% os_event_set
</code></pre></div><p>These functions are largely wrappers around a pthread locking implementation. From the version history these were imported from MySQL-5.0 with minor modification in 2013 compared to the pthread implementation that receives significant maintenance from the glibc community represented by major CPU architecture manufacturers.</p><p>Thankfully, MySQL has a compile option <em>-DMUTEXTYPE=sys</em> that results in <a href=https://github.com/mysql/mysql-server/blob/mysql-5.7.28/storage/innobase/include/ib0mutex.h#L110..L123 target=_blank rel="noopener noreferrer">pthreads being used directly</a> and that increased x86 performance marginally, but much more significantly on POWER (understandable as since the sync_array elements have multiple instances on the same cache line size of 128 bytes compared to x86_64 which is 64 bytes). I&rsquo;ll soon get to benchmarking these changes in more detail and generate some bug report to get this default changed in distro packages at least.</p><h2 id=encode---another-example>Encode - Another example</h2><p>Even while carrying out this investigation a <a href=https://jira.mariadb.org/browse/MDEV-21285 target=_blank rel="noopener noreferrer">MariaDB zulip chat</a> exposed a benchmark of <a href=https://mariadb.com/kb/en/library/encode/ target=_blank rel="noopener noreferrer">ENCODE</a> (notably deprecated in MySQL-5.7) having scaling problems. Using the exact techniques here it was quick to generate and extracted a perf profile (<a href=https://jira.mariadb.org/browse/MDEV-21285 target=_blank rel="noopener noreferrer">MDEV-21285</a>) and stack that showed every initial guess at the source of the problem ‚Äì including mine ‚Äì was incorrect. With the perf profile, however, the nature of the problem is quite clear ‚Äì unlike the solution. That requires more thought.</p><h2 id=reportshow-your-perf-recordings>Report/Show your perf recordings</h2><p>Alongside its low overhead during recording, the useful aspect of perf from a DBA perspective is that perf stack traces show only the MySQL code being executed, and the frequency of its execution. There is no exposed database data, SQL queries, or table names in the output. However, the <a href=https://www.kernel.org/doc/html/latest/admin-guide/perf-security.html#overview target=_blank rel="noopener noreferrer">Perf Events and tool security (item 4)</a> indicates that registers can be captured in a perf recording so be careful about sharing raw perf data.</p><p>Once the raw perf data is processed by <em>perf report</em>, with correct debug info and kernel, there are no addresses and only mysqld and kernel function names in its output. The most that is being exposing by sharing a perf report is the frequency of use of the MySQL code that was obtained externally. This should be enough to convince strict and competent managers and security people to sharing the perf recordings.</p><p>With some realistic expectations (code can&rsquo;t execute in 0 time, all of the database can&rsquo;t be in CPU cache) you should now be able to show the parts of MySQL that are limiting your queries.</p><h3 id=resulting-bug-reports>Resulting bug reports</h3><p>MySQL:</p><ul><li><a href="https://bugs.mysql.com/bug.php?id=97777" target=_blank rel="noopener noreferrer">bug 97777</a></li><li><a href="https://bugs.mysql.com/bug.php?id=97822" target=_blank rel="noopener noreferrer">bug 97822</a></li></ul><p>MariaDB:</p><ul><li><a href=https://jira.mariadb.org/browse/MDEV-21145 target=_blank rel="noopener noreferrer">MDEV-21145¬†</a></li><li><a href=https://jira.mariadb.org/browse/MDEV-21452 target=_blank rel="noopener noreferrer">MDEV-21452</a></li><li><a href=https://jira.mariadb.org/browse/MDEV-21212 target=_blank rel="noopener noreferrer">MDEV-21212</a></li></ul><p>&ndash;</p><p><em>Disclaimer: The postings on this site are the authors own and don&rsquo;t necessarily represent IBM&rsquo;s positions, strategies or opinions.</em></p><p><em>The content in this blog is provided in good faith by members of the open source community. Percona has not edited or tested the technical content. Views expressed are the authors‚Äô own. When using the advice from this or any other online resource test ideas before applying them to your production systems, and always secure a working back up.</em></p><p>Photo by <a href="https://unsplash.com/@ripato?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText" target=_blank rel="noopener noreferrer">Ricardo Gomez Angel</a> on <a href="https://unsplash.com/s/photos/perforations?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText" target=_blank rel="noopener noreferrer">Unsplash</a> <span aria-label="End of article." role=text class=tombstone>‚àé</span></p></div></article></div></main><footer class=page><h1 class=aria-only id=footer-heading aria-hidden=false>Footer</h1><div class=page-footer><nav class=footer><ul><li><a href=https://www.percona.com/about-percona target=_blank rel="noopener noreferrer"><span>About</span></a></li><li><a href=https://www.percona.com/legal target=_blank rel="noopener noreferrer"><span>Legal</span></a></li><li><a href=https://forums.percona.com/ target=_blank rel="noopener noreferrer"><span>Forums</span></a></li><li><a href=https://www.percona.com/about-percona/contact target=_blank rel="noopener noreferrer"><span>Contact</span></a></li></ul></nav></div><aside>¬© Percona Community. MySQL, InnoDB, MariaDB and MongoDB are trademarks of their respective owners.</aside></footer><script type=text/javascript src=https://percona.community/js/aria.5f30892348d4662fe548bb410f15fc6fe2e1cbfd6473beb3c3ed1d6b362568bbea48896a9f2302a4f78f4614904ca3ef43155ae26f063ed84ae957f951e19647.js integrity="sha512-XzCJI0jUZi/lSLtBDxX8b+Lhy/1kc76zw+0dazYlaLvqSIlqnyMCpPePRhSQTKPvQxVa4m8GPthK6Vf5UeGWRw==" defer></script></body></html>